<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Catbox Admin | ID æŸ¥è©¢</title>

    <script>
        (function() {
            const adminPw = localStorage.getItem('adminPw');
            if (!adminPw) {
                alert('âš ï¸ è«‹å…ˆç™»å…¥ç®¡ç†å“¡å¾Œå°');
                window.location.href = 'admin.html';
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #FDFCFB; color: #5D4037; font-family: sans-serif; }
        .admin-card { background: white; border: 1px solid #D7CCC8; border-radius: 24px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        .btn-primary { background-color: #5D4037; color: white; transition: all 0.3s; }
        .btn-primary:hover { background-color: #4E342E; transform: translateY(-1px); }
        .btn-outline { border: 1px solid #D7CCC8; color: #8D6E63; transition: all 0.3s; }
        .btn-outline:hover { background-color: #EFEBE9; }
        input, textarea { border: 1px solid #D7CCC8 !important; border-radius: 12px !important; padding: 12px !important; outline: none; }
        input:focus { border-color: #8D6E63 !important; ring: 2px #D7CCC8; }
        .animate-fade-in { animation: fadeIn 0.6s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <main class="max-w-2xl mx-auto animate-fade-in">
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-2xl font-bold text-[#5D4037]">ID æŸ¥è©¢ç³»çµ±</h1>
                <p class="text-sm text-[#8D6E63]">Catbox å…§éƒ¨ç®¡ç†å·¥å…·</p>
            </div>
            <button onclick="location.href='admin.html'" class="btn-outline px-4 py-2 rounded-full text-sm font-bold">è¿”å›å¾Œå°</button>
        </div>

        <section class="admin-card p-6 md:p-8 mb-6">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                <span class="text-xl">ğŸ”</span> å®¢æˆ¶ ID æŸ¥è©¢
            </h3>

            <div class="flex flex-col md:flex-row gap-3">
                <div class="relative flex-grow">
                    <input id="cid" list="id-list" placeholder="è¼¸å…¥æˆ–é¸æ“‡ å®¢æˆ¶ID (Username)" class="w-full">
                    <datalist id="id-list"></datalist>
                </div>
                <button id="btn" class="btn-primary px-8 py-3 rounded-xl font-bold shadow-md">æŸ¥è©¢</button>
            </div>
            <p id="status" class="text-xs mt-3 text-[#A1887F] font-medium min-h-[1rem]"></p>
        </section>

        <div id="result-container" class="hidden animate-fade-in">
            <section class="admin-card p-6 md:p-8 border-l-4 border-l-[#8D6E63]">
                <div id="result"></div>
            </section>
        </div>
    </main>

<script>
const API = 'https://script.google.com/macros/s/AKfycby2I6Q2M67npEFW-Vqi14JS3L7rtuQ9DLD35KwhwCaGpyt3xBnRfNyeLcOGXfslA9sx/exec';

// âœ… å·²æ›´æ–°ç‚ºæ‚¨æŒ‡å®šçš„å»£æ±è©±èªå¥
const TEMPLATE = 
`æ­¡è¿å®¢äººä½¿ç”¨å³æ™‚ Check å–®åŠŸèƒ½ âœ¨
ä½ å˜…å°ˆå±¬ç¶²å€ç‚ºï¼š[link]

ğŸ“¦ ç‹€æ…‹èªªæ˜ï¼š
1. æˆåŠŸè³¼å…¥å¾Œç´„ 20 åˆ†é˜æœƒæ›´æ–°ç¶²é ã€‚
2. åˆ°è²¨å¾Œéš”æ—¥ï¼Œæˆ‘å“‹æœƒæ›´æ–°é‡é‡åŠåœ–ç‰‡ã€‚

å¦‚æœ‰ä»»ä½•ç–‘å•ï¼Œæ­¡è¿éš¨æ™‚è¯çµ¡æˆ‘å“‹ï¼Œè¬è¬ï¼`;

const cidEl = document.getElementById('cid');
const listEl = document.getElementById('id-list');
const statusEl = document.getElementById('status');
const resultEl = document.getElementById('result');
const resultContainer = document.getElementById('result-container');

document.getElementById('btn').addEventListener('click', search);
cidEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') search(); });

// é€²å…¥é é¢è‡ªå‹•è®€å– ID æ¸…å–®
loadIdList();

function loadIdList(){
    const pw = (localStorage.getItem('adminPw') || '').trim();
    if(!pw) return; // å®ˆé–€å“¡è…³æœ¬å·²è™•ç†è·³è½‰

    statusEl.textContent = 'â³ æ­£åœ¨åŒæ­¥å®¢æˆ¶ ID æ¸…å–®...';

    const body = new URLSearchParams();
    body.append('action','getCustomerIds');
    body.append('password', pw);

    fetch(API,{ method:'POST', body })
        .then(r=>r.json())
        .then(d=>{
            if(d.error) throw new Error(d.error);
            const ids = Array.isArray(d.ids) ? d.ids : [];
            listEl.innerHTML = ids.map(v=>`<option value="${escAttr(v)}"></option>`).join('');
            statusEl.textContent = 'âœ… ID æ¸…å–®å·²æ›´æ–°';
            setTimeout(() => statusEl.textContent = '', 3000);
        })
        .catch(err=>{
            statusEl.textContent = 'âŒ ç„¡æ³•è¼‰å…¥ ID æ¸…å–®';
        });
}

function search(){
    const id = (cidEl.value || '').trim();
    if(!id) return;

    const pw = (localStorage.getItem('adminPw') || '').trim();
    statusEl.textContent='â³ æŸ¥è©¢ä¸­...';
    resultContainer.classList.add('hidden');

    const body = new URLSearchParams();
    body.append('action','findUserById');
    body.append('password', pw);
    body.append('custId', id);

    fetch(API,{ method:'POST', body })
        .then(r=>r.json())
        .then(d=>{
            statusEl.textContent='';
            if(d.error){
                alert('æ‰¾ä¸åˆ°æ­¤ IDï¼Œè«‹æª¢æŸ¥æ‹¼å­—æ˜¯å¦æ­£ç¢º');
                return;
            }

            const url = d.url || '';
            const msg = TEMPLATE.replace('[link]', url);

            resultContainer.classList.remove('hidden');
            resultEl.innerHTML = `
                <div class="mb-4">
                    <label class="block text-xs font-bold text-[#8D6E63] uppercase tracking-wider mb-1">å®¢æˆ¶åç¨± Username</label>
                    <div class="text-lg font-bold text-[#5D4037]">${esc(d.username||'')}</div>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-[#8D6E63] uppercase tracking-wider mb-1">å°ˆå±¬æŸ¥è©¢ URL</label>
                    <div class="flex gap-2">
                        <input value="${escAttr(url)}" readonly onclick="this.select()" class="flex-grow bg-[#FAFAFA] text-sm">
                        <button onclick="window.open('${url}')" class="px-4 border border-[#D7CCC8] rounded-xl hover:bg-gray-50 text-sm">é–‹å•Ÿ</button>
                    </div>
                </div>

                <div class="pt-4 border-t border-[#F5F5F5]">
                    <div class="flex justify-between items-center mb-2">
                         <label class="block text-xs font-bold text-[#8D6E63] uppercase tracking-wider">è‡ªå‹•ç”Ÿæˆå›è¦†æ–‡å­—</label>
                         <button type="button" onclick="copyMsg(event)" class="text-sm font-bold text-[#5D4037] hover:underline">ä¸€éµè¤‡è£½</button>
                    </div>
                    <textarea id="msg" class="w-full text-sm leading-relaxed text-gray-600 bg-[#F9F9F9] h-48">${msg}</textarea>
                </div>
            `;
        })
        .catch(err=>{
            statusEl.textContent='âŒ æŸ¥è©¢å¤±æ•—';
        });
}

function copyMsg(event){
    const t = document.getElementById('msg');
    if(!t) return;
    t.select();
    document.execCommand('copy');
    
    const btn = event.target;
    const originalText = btn.innerText;
    btn.innerText = 'âœ… å·²è¤‡è£½ï¼';
    setTimeout(() => btn.innerText = originalText, 2000);
}

function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
}
function escAttr(s){ return esc(s).replace(/\n/g,' '); }
</script>

</body>
</html>
