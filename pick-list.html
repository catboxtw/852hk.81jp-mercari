function getPickListData_() {
  const ss = SpreadsheetApp.openById(MAIN_SPREADSHEET_ID);
  const sh = ss.getSheetByName(MAIN_ORDER_SHEET);
  const currencySh = ss.getSheetByName("Currency");
  
  const lastRow = sh.getLastRow();
  if (lastRow < 2) return json({ allGroups: {}, latestGroup: "" });

  // 抓取 訂單 分頁資料
  const data = sh.getRange(2, 1, lastRow - 1, 19).getValues();
  
  // --- 修正定位：從 C 欄日期找最後一行，對應 A 欄團號 ---
  let latestGroup = "";
  try {
    const cLastRow = currencySh.getLastRow();
    // 抓 A9 到 C 最後一行的資料 (A欄是團號, C欄是日期)
    const cData = currencySh.getRange(9, 1, Math.max(1, cLastRow - 8), 3).getValues();
    
    for (let j = cData.length - 1; j >= 0; j--) {
      const groupName = cData[j][0]; // A 欄
      const dateVal = cData[j][2];    // C 欄
      // 只要 C 欄有日期，就取該行的 A 欄當團號
      if (dateVal instanceof Date || (dateVal && !isNaN(Date.parse(dateVal)))) {
        latestGroup = String(groupName).trim();
        break;
      }
    }
  } catch(e) { latestGroup = ""; }

  let groups = {};

  data.forEach(r => {
    const groupName = String(r[0] || "").trim();
    if (!groupName || groupName === "未到貨") return;

    if (!groups[groupName]) {
      groups[groupName] = {
        HK: { totalWeight: 0, customers: {} },
        TW: { totalWeight: 0, customers: {} }
      };
    }

    const pos = String(r[2] || "").trim();    
    const custId = String(r[3] || "").trim(); 
    const code = String(r[14] || "").trim();  
    const weight = parseFloat(r[16]) || 0;    
    const img = String(r[18] || "").trim(); 
    
    const region = (pos === "Taiwan") ? "TW" : "HK";
    const fullId = `${pos}_${custId}`;

    groups[groupName][region].totalWeight += weight;

    if (!groups[groupName][region].customers[fullId]) {
      groups[groupName][region].customers[fullId] = [];
    }
    if (code !== "") {
      groups[groupName][region].customers[fullId].push({ code: code, img: img });
    }
  });

  return json({
    latestGroup: latestGroup,
    allGroups: groups
  });
}
