<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç®¡ç†ç³»çµ± - ğŸ“¦ åŸ·è²¨æ¸…å–®</title>
<style>
  :root { --primary: #2563eb; --hk-color: #1e40af; --tw-color: #7c3aed; --bg: #f8fafc; }
  body { font-family: -apple-system, "Segoe UI", sans-serif; background: var(--bg); margin: 0; padding-bottom: 50px; }
  
  /* å°è¦½åˆ—æ¨£å¼ (èˆ‡ Admin Page ä¸€è‡´) */
  .admin-nav { background: #fff; border-bottom: 1px solid #e2e8f0; position: sticky; top: 0; z-index: 1000; }
  .nav-content { display: flex; justify-content: space-around; max-width: 600px; margin: 0 auto; padding: 10px 5px; }
  .nav-btn { background: none; border: none; font-size: 11px; color: #64748b; cursor: pointer; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
  .nav-btn span { font-size: 20px; }
  .nav-btn.active { color: var(--primary); font-weight: bold; }

  /* ç™»å…¥é¢æ¿ (è‹¥æœªç™»å…¥æ‰é¡¯ç¤º) */
  #loginPanel { padding: 100px 20px; text-align: center; }
  .login-input { padding: 12px; width: 220px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; margin-bottom: 12px; }
  .login-btn { padding: 12px 40px; background: var(--primary); color: #fff; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

  /* ä¸»é¢æ¿å…§å®¹ */
  #mainPanel { max-width: 600px; margin: 0 auto; padding: 15px; display: none; }
  
  /* åœ˜è™Ÿé¸æ“‡ Tabs */
  #groupTabs { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding: 5px 0; scrollbar-width: none; }
  #groupTabs::-webkit-scrollbar { display: none; }
  .tab-btn { padding: 8px 18px; background: #e2e8f0; color: #475569; border: none; border-radius: 20px; font-size: 14px; cursor: pointer; white-space: nowrap; transition: 0.2s; }
  .tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 4px 6px -1px rgba(37,99,235,0.3); }

  /* å€åŸŸå¤§æ¨™é¡Œ */
  .region-section { background: #fff; border-radius: 16px; padding: 15px; margin-bottom: 25px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border-top: 6px solid; }
  .hk-section { border-top-color: var(--hk-color); }
  .tw-section { border-top-color: var(--tw-color); }
  .region-title { font-size: 18px; font-weight: 800; color: #1e293b; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
  .total-weight { font-size: 12px; background: #dcfce7; color: #166534; padding: 4px 12px; border-radius: 30px; font-weight: bold; }

  /* å¤§ç´…æ¡†: å®¢äººåˆ†çµ„å¡ç‰‡ */
  .cust-card { display: flex; border: 2.5px solid #ef4444; border-radius: 12px; margin-bottom: 20px; background: #fff; overflow: hidden; min-height: 100px; }
  .min-code-side { background: #ef4444; color: #fff; font-size: 32px; font-weight: 900; width: 65px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .cust-info-side { flex: 1; padding: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  .cust-name { font-weight: bold; font-size: 17px; color: #1e293b; margin-bottom: 12px; }
  
  /* ç´°é»ƒæ¡†å®¹å™¨ */
  .code-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
  .item-box { display: flex; flex-direction: column; align-items: center; gap: 5px; border: 1.5px solid #f59e0b; background: #fffbeb; padding: 6px; border-radius: 10px; min-width: 60px; }
  .code-num { font-weight: 800; font-size: 15px; color: #92400e; }
  .thumb { width: 55px; height: 55px; object-fit: cover; border-radius: 6px; background: #f1f5f9; border: 1px solid #fde68a; }

  .loading { text-align: center; padding: 50px; color: #94a3b8; font-weight: 500; }
</style>
</head>
<body>

<div class="admin-nav" id="adminNav" style="display:none">
  <div class="nav-content">
    <button class="nav-btn" onclick="location.href='index.html'"><span>ğŸ”</span>æŸ¥è©¢ ID</button>
    <button class="nav-btn" onclick="location.href='admin.html'"><span>âš–ï¸</span>åˆ°è²¨ç£…é‡</button>
    <button class="nav-btn active" onclick="location.href='pick-list.html'"><span>ğŸ“¦</span>åŸ·è²¨</button>
    <button class="nav-btn" onclick="alert('é–‹ç™¼ä¸­')"><span>ğŸ“¢</span>é€šçŸ¥å®¢äºº</button>
  </div>
</div>

<div id="loginPanel">
  <h2>ğŸ“¦ åŸ·è²¨ç®¡ç†ç™»å…¥</h2>
  <input type="password" id="pw" class="login-input" placeholder="è¼¸å…¥å¯†ç¢¼">
  <br>
  <button class="login-btn" onclick="manualLogin()">ç™»å…¥ç³»çµ±</button>
</div>

<div id="mainPanel">
  <div id="groupTabs"></div>
  <div id="mainContent"></div>
</div>

<script>
const API = 'https://script.google.com/macros/s/AKfycby2I6Q2M67npEFW-Vqi14JS3L7rtuQ9DLD35KwhwCaGpyt3xBnRfNyeLcOGXfslA9sx/exec';
let GLOBAL_DATA = null;
let CURRENT_GROUP = "";

// ğŸš€ é—œéµé‚è¼¯ï¼šæª¢æŸ¥ç™»å…¥ç‹€æ…‹
window.onload = function() {
  const savedPw = localStorage.getItem('adminPassword');
  if (savedPw === '4916') {
    showMain(savedPw);
  }
};

function manualLogin() {
  const pw = document.getElementById('pw').value;
  if (pw === '4916') {
    localStorage.setItem('adminPassword', pw);
    showMain(pw);
  } else {
    alert('å¯†ç¢¼ä¸æ­£ç¢º');
  }
}

function showMain(pw) {
  document.getElementById('loginPanel').style.display = 'none';
  document.getElementById('adminNav').style.display = 'block';
  document.getElementById('mainPanel').style.display = 'block';
  loadData(pw);
}

async function loadData(pw) {
  const content = document.getElementById('mainContent');
  content.innerHTML = '<div class="loading">ğŸ“¦ æ­£åœ¨åŒæ­¥è¨‚å–®è³‡æ–™...</div>';
  
  try {
    const res = await fetch(API, {
      method: 'POST',
      body: new URLSearchParams({ action: 'getPickListData', password: pw })
    });
    const data = await res.json();
    
    if (!data.allGroups || Object.keys(data.allGroups).length === 0) {
      content.innerHTML = '<div class="loading">ç›®å‰æ²’æœ‰éœ€è¦åŸ·è²¨çš„è¨‚å–®ã€‚</div>';
      return;
    }

    GLOBAL_DATA = data.allGroups;
    // æ‰¾å‡ºæœ€æ–°åœ˜è™Ÿ
    CURRENT_GROUP = GLOBAL_DATA[data.latestGroup] ? data.latestGroup : Object.keys(GLOBAL_DATA).sort().reverse()[0];
    
    renderTabs();
    renderGroup(CURRENT_GROUP);
  } catch (e) {
    content.innerHTML = '<div class="loading">âŒ é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ã€‚</div>';
  }
}

function renderTabs() {
  const tabs = document.getElementById('groupTabs');
  const groupNames = Object.keys(GLOBAL_DATA).reverse(); 
  tabs.innerHTML = groupNames.map(name => 
    `<button class="tab-btn ${name === CURRENT_GROUP ? 'active' : ''}" onclick="switchGroup('${name}')">${name}</button>`
  ).join('');
}

function switchGroup(name) {
  CURRENT_GROUP = name;
  renderTabs();
  renderGroup(name);
}

function renderGroup(groupName) {
  const container = document.getElementById('mainContent');
  const groups = GLOBAL_DATA[groupName];
  container.innerHTML = '';

  ['HK', 'TW'].forEach(regionKey => {
    const info = groups[regionKey];
    if (Object.keys(info.customers).length === 0) return;

    const label = regionKey === 'HK' ? 'ğŸ‡­ğŸ‡° é¦™æ¸¯åœ˜' : 'ğŸ‡¹ğŸ‡¼ å°ç£åœ˜';
    const cssClass = regionKey === 'HK' ? 'hk-section' : 'tw-section';

    let html = `<div class="region-section ${cssClass}"><div class="region-title">${label} <span class="total-weight">ç¸½é‡: ${info.totalWeight.toFixed(3)} kg</span></div>`;

    const sortedCustIds = Object.keys(info.customers).sort();
    sortedCustIds.forEach(custId => {
      const items = info.customers[custId].sort((a, b) => Number(a.code) - Number(b.code));
      const minCode = items.length > 0 ? items[0].code : '-';

      html += `
        <div class="cust-card">
          <div class="min-code-side">${minCode}</div>
          <div class="cust-info-side">
            <div class="cust-name">${custId}</div>
            <div class="code-container">
              ${items.map(item => `
                <div class="item-box">
                  ${item.img ? `<img src="${item.img}" class="thumb" loading="lazy">` : `<div class="thumb" style="display:flex;align-items:center;justify-content:center;font-size:10px;color:#cbd5e1">ç„¡åœ–</div>`}
                  <div class="code-num">#${item.code}</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    });
    html += `</div>`;
    container.innerHTML += html;
  });
}
</script>
</body>
</html>
