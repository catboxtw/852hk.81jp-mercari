<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
<title>ğŸ‡¯ğŸ‡µç®¡ç†å“¡å¾Œå°</title>
<style>
  :root { --primary-color: #2563eb; --bg-light: #f8fafc; --warn-color: #f57c00; --success-color: #059669; }
  * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
  body { background: var(--bg-light); margin: 0; padding: 0; font-family: -apple-system, sans-serif; overflow-x: hidden; }
  .admin-wrap { max-width: 1000px; margin: 0 auto; padding: 15px; padding-bottom: 100px; }
  .admin-login { background: #fff; padding: 30px 20px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 95%; max-width: 350px; margin: 60px auto; text-align: center; }
  .admin-nav { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
  .nav-btn { padding: 12px 5px; border-radius: 10px; background: #fff; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; gap: 5px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
  .nav-btn.active { background: var(--primary-color); color: #fff; }
  .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; }
  .filter-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; background: #fff; cursor: pointer; font-weight: bold; color: #475569; }
  .filter-btn.active { background: #e2e8f0; border-color: #94a3b8; color: #1e293b; }
  .card-fixed { display: flex; background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 2px solid transparent; }
  .pending-card { border-color: var(--warn-color) !important; background: #fffaf5 !important; }
  .code-tag { background: #475569; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 6px; }
  .card-left { flex: 1; padding-right: 10px; display: flex; flex-direction: column; gap: 4px; }
  .card-right { width: 95px; text-align: center; flex-shrink: 0; }
  .pos-label { font-size: 11px; color: #94a3b8; font-weight: bold; margin-top: 4px; }
  .pos-group { display: flex; gap: 3px; margin: 2px 0 6px 0; }
  .pos-btn { flex: 1; padding: 6px 0; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 6px; font-size: 10px; cursor: pointer; color: #64748b; font-weight: 600; }
  .pos-btn.selected { background: #fee2e2; border-color: #ef4444; color: #b91c1c; box-shadow: inset 0 0 4px rgba(239, 68, 68, 0.1); }
  .id-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; background: #fff; }
  .weight-row { display: flex; align-items: center; gap: 6px; margin-top: 5px; }
  .weight-input { flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 15px; }
  .weight-unit { font-weight: bold; color: #64748b; font-size: 13px; }
  .card-img-wrap { width: 90px; height: 90px; background: #f1f5f9; border-radius: 8px; overflow: hidden; margin-bottom: 8px; border: 1px solid #eee; position: relative; }
  .card-img { width: 100%; height: 100%; object-fit: cover; }
  .preview-label { position: absolute; bottom: 0; width: 100%; background: rgba(37, 99, 235, 0.8); color: white; font-size: 9px; padding: 2px 0; }
  .photo-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
  #batchBar { display: none; background: #fff4e5; border: 1px solid #ffe0b2; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  #floatingSave { display: none; position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px; border-radius: 50%; background: var(--warn-color); color: white; border: none; font-size: 30px; z-index: 101; box-shadow: 0 4px 15px rgba(0,0,0,0.3); align-items: center; justify-content: center; }
  .green-tag { background: var(--success-color); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-top: 5px; cursor: pointer; }
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; }
  .modal-content { background:#fff; width:92%; max-width:400px; padding:20px; border-radius:16px; display:flex; flex-direction:column; gap:12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
  .modal-input { padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; width: 100%; outline: none; height: 45px; display: block; -webkit-appearance: none; }
  .modal-input:focus { border-color: var(--primary-color); }
  .add-item-btn { width:100%; padding:15px; background:#fff; border:2px dashed #cbd5e1; border-radius:12px; color:#64748b; font-weight:bold; margin-top:20px; cursor:pointer; }
</style>
</head>

<body>
<datalist id="idList"></datalist>
<main class="admin-wrap">
  <div style="text-align: center; margin-bottom: 20px;"><h2>ç®¡ç†å“¡å¾Œå°</h2></div>

  <div id="login" class="admin-login">
    <h3 style="margin-top:0">èº«åˆ†é©—è­‰</h3>
    <input id="pw" type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:2px solid #ddd;">
    <button onclick="doLogin()" style="width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight:bold;">é€²å…¥ç®¡ç†ç³»çµ±</button>
    <div id="loginStatus" style="margin-top:10px; color: #64748b;"></div>
  </div>

  <div id="adminNav" class="admin-nav" style="display:none;">
    <button class="nav-btn" onclick="location.href='id-search.html'"><span>ğŸ”</span>æŸ¥è©¢ ID</button>
    <button class="nav-btn active"><span>âš–ï¸</span>åˆ°è²¨ç£…é‡</button>
    <button class="nav-btn" onclick="location.href='pick-list.html'"><span>ğŸ“¦</span>åŸ·è²¨</button>
    <button class="nav-btn" onclick="alert('é–‹ç™¼ä¸­')"><span>ğŸ“¢</span>é€šçŸ¥å®¢äºº</button>
  </div>

  <div id="batchBar" style="position: relative;">
    <button onclick="clearPendingUpdates()" style="position: absolute; top: 5px; right: 5px; background: none; border: none; color: #94a3b8; font-size: 18px; cursor: pointer; padding: 5px;">âœ•</button>
    <div style="margin-bottom: 10px; border-bottom: 1px dashed #ffe0b2; padding-bottom: 8px;">
      <label style="font-size: 12px; color: #e65100; font-weight: bold; display: block; margin-bottom: 4px;">ğŸ“… åˆ°è²¨æ—¥æœŸ (åƒ…ç”¨æ–¼é‡é‡ä¿®æ”¹):</label>
      <input type="date" id="arrivalDateInput" style="width: 100%; padding: 8px; border: 1px solid #ffcc80; border-radius: 6px;">
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <span id="pendingMsg" style="color: #e65100; font-weight: bold;">ğŸ“ 0 é …å¾…å„²å­˜</span>
      <button onclick="saveBatchData()" style="background:#f57c00; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold;">ğŸ’¾ å„²å­˜å…¨éƒ¨</button>
    </div>
  </div>

<div id="mainPanel" style="display:none">
    <div class="filter-bar">
      <button class="filter-btn active" id="f-todo" onclick="setFilter('todo')">æœªå®Œæˆ</button>
      <button class="filter-btn" id="f-unrated" onclick="setFilter('unrated')">æœªè©•åƒ¹</button>
      <button class="filter-btn" id="f-done" onclick="setFilter('done')">å·²å®Œæˆ</button>
      <button class="filter-btn" id="f-all" onclick="setFilter('all')">å…¨éƒ¨</button>
    </div>

    <div id="latestShipDateBox" style="background: #eff6ff; border: 1px solid #bfdbfe; padding: 12px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 20px;">ğŸšš</span>
      <div id="latestShipDateText" style="font-size: 16px; font-weight: bold; color: #1e3a8a;">è®€å–ä¸­...</div>
    </div>

    <div id="arrivalTabs" style="display:flex; gap:8px; margin-bottom:15px; overflow-x:auto; padding-bottom:5px;"></div>
    
    <div id="list"></div>

    <button class="add-item-btn" onclick="openAddModal()">â• åŠ å…¥æ–°å•†å“åˆ°ä¸»è¡¨</button>
  </div>
</main>

<div id="addModal" class="modal">
  <div class="modal-content">
    <h3 style="margin:0; text-align:center;">â• åŠ å…¥æ–°å•†å“</h3>
    <input type="date" id="addDate" class="modal-input">
    <select id="addShop" class="modal-input"><option value="">é¸æ“‡å•†åº—...</option></select>
    <input type="text" id="addLink" placeholder="å•†å“ç¶²å€" class="modal-input">
    <input type="text" id="addItem" placeholder="å•†å“åç¨±" class="modal-input">
    <input type="number" id="addJpy" placeholder="åƒ¹éŒ¢ (JPY)" class="modal-input">
    <select id="addPos" class="modal-input"><option value="">é¸æ“‡ä¾†æº...</option></select>
    <input type="text" id="addCustId" placeholder="Customer ID" list="idList" class="modal-input">
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="closeAddModal()" style="flex:1; padding:12px; background:#f1f5f9; border:none; border-radius:8px; font-weight:bold;">å–æ¶ˆ</button>
      <button id="submitAddBtn" onclick="submitNewItem()" style="flex:1; padding:12px; background:var(--primary-color); color:#fff; border:none; border-radius:8px; font-weight:bold;">ç¢ºå®šåŠ å…¥</button>
    </div>
  </div>
</div>

<button id="floatingSave" onclick="saveBatchData()">ğŸ’¾</button>

<script>
const API = 'https://script.google.com/macros/s/AKfycby2I6Q2M67npEFW-Vqi14JS3L7rtuQ9DLD35KwhwCaGpyt3xBnRfNyeLcOGXfslA9sx/exec'; 
const CLOUD_NAME = 'disr3dmsj';
const UPLOAD_PRESET = 'mercariup';
const CLOUD_FOLDER = 'mercari';
const LINK_PREVIEW_KEY = '03b25d4673fab76cc420aba868dff16b';
const POS_MAP = { 'Wts': 'Whatsapp', 'IG': 'IG', 'FB': 'FB', 'Line': 'Line', 'TW': 'Taiwan' };

let password = '', allItems = [], allCustomerIds = [], currentFilter = 'todo', currentArrival = 'æœªåˆ°è²¨', pendingUpdates = new Map(), editingRows = new Set();
let urlPreviewCache = new Map();
try {
  const savedCache = localStorage.getItem('img_cache');
  if (savedCache) {
    // å°‡ Array è½‰å› Map
    urlPreviewCache = new Map(JSON.parse(savedCache));
  }
} catch (e) { 
  console.warn("å¿«å–è®€å–å¤±æ•—ï¼Œé‡æ–°åˆå§‹åŒ–"); 
  urlPreviewCache = new Map();
}

  window.onload = function() {
  const savedPw = localStorage.getItem('adminPassword');
  if (savedPw === '4916') {
    // é€™è£¡èª¿ç”¨ä½ åŸæœ¬ admin.html è£¡é€²å…¥ä¸»ç•Œé¢çš„å‡½æ•¸
    // å‡è¨­ä½ çš„ç™»å…¥å‡½æ•¸å« doLogin(pw)
    doLogin(savedPw); 
  }
};

function setFilter(type) {
  currentFilter = type;
  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
  const activeBtn = document.getElementById('f-' + type);
  if (activeBtn) activeBtn.classList.add('active');
  
  // å¦‚æœä¸æ˜¯ã€Œæœªå®Œæˆã€é é¢ï¼Œéš±è—æœ€æ–°æ—¥æœŸæç¤ºæ¡†ï¼Œä¿æŒç°¡æ½”
  document.getElementById('latestShipDateBox').style.display = (type === 'todo' || type === 'all') ? 'flex' : 'none';
  
  render();
}

// ä¿®æ­£å¾Œçš„æ—¥æœŸæŠ“å–é‚è¼¯
function updateLatestShipDate() {
  const dateTextEl = document.getElementById('latestShipDateText');
  
  // 1. å…ˆå¾ allItems æå–æ‰€æœ‰ shipDate
  const allDates = allItems
    .map(i => i.shipDate)
    .filter(d => d && d.trim() !== "" && d !== "æœªå¡«");

  if (allDates.length === 0) {
    // 2. å¦‚æœ items è£¡æ²’æ—¥æœŸï¼Œé¡¯ç¤ºé è¨­æç¤ºï¼ˆæˆ–å¯ä»¥é¡¯ç¤ºä¸€å€‹é æœŸæ—¥æœŸï¼‰
    dateTextEl.textContent = "å¾…å…¥åº«å¾Œè‡ªå‹•è¨ˆç®—"; 
    return;
  }

  // 3. æ’åºæ‰¾å‡ºæœ€æ–°çš„æ—¥æœŸ
  allDates.sort((a, b) => {
    // è™•ç† YYYY/MM/DD æˆ– YYYY-MM-DD æ ¼å¼
    return new Date(b.replace(/\//g, '-')) - new Date(a.replace(/\//g, '-'));
  });

  const latestDate = new Date(allDates[0].replace(/\//g, '-'));
  
  // 4. æ ¹æ“šä½ è¦æ±‚ã€Œå–æœ€å¾Œä¸€å€‹æ—¥æœŸ+1ã€æˆ–æ˜¯ç›´æ¥é¡¯ç¤ºè©²åœ˜æ—¥æœŸ
  // é€™è£¡é¡¯ç¤ºæœ€æ–°çš„ä¸€åœ˜æ—¥æœŸ
  dateTextEl.textContent = allDates[0]; 
  
  // å¦‚æœä½ æƒ³å¼·èª¿é€™æ˜¯ã€Œæœ€æ–°ä¸€åœ˜ã€ï¼Œå¯ä»¥åŠ é»é¡è‰²
  dateTextEl.style.color = "#1e3a8a";
}
  
function doLogin() {
  const pwInput = document.getElementById('pw');
  password = pwInput.value.trim();
  if(!password) return;
  document.getElementById('loginStatus').textContent = 'é©—è­‰ä¸­...';

  fetch(API, {method:'POST', body: new URLSearchParams({action:'getAdminItems', password})})
  .then(r => r.json())
  .then(d => {
    if(d.error) throw new Error(d.error);
    allItems = d.items || [];
    // åœ¨ doLogin æˆåŠŸç²å–è³‡æ–™å¾ŒåŠ å…¥
localStorage.setItem('adminPassword', password);
    
    // --- æ—¥æœŸæ›´æ–°é‚è¼¯ ---
    if (d.latestShipDate) {
      document.getElementById('latestShipDateText').textContent = d.latestShipDate;
    } else {
      updateLatestShipDate(); 
    }

    // --- é¸å–®æ›´æ–° (å•†åº—) ---
    const shopSelect = document.getElementById('addShop');
    let shops = [...new Set(allItems.map(i => (i.shop || i.store || '').trim()))].filter(s => s !== "");
    shopSelect.innerHTML = '<option value="">é¸æ“‡å•†åº—...</option>' + 
      (shops.length ? shops.sort().map(s => `<option value="${esc(s)}">${esc(s)}</option>`).join('') : ["Mercari", "Amazon", "Rakuten"].map(s => `<option value="${s}">${s}</option>`).join(''));

    // --- é¸å–®æ›´æ–° (Position) ---
    const posSelect = document.getElementById('addPos');
    let positions = [...new Set(allItems.map(i => (i.position || i.pos || '').trim()))].filter(p => p !== "");
    posSelect.innerHTML = '<option value="">é¸æ“‡ä¾†æº...</option>' + 
      (positions.length ? positions.sort().map(p => `<option value="${esc(p)}">${esc(p)}</option>`).join('') : Object.values(POS_MAP).map(p => `<option value="${p}">${p}</option>`).join(''));

    // --- æŠ“å–å®¢æˆ¶ ID ---
    fetch(API, {method:'POST', body: new URLSearchParams({action:'getCustomerIds', password})})
    .then(r=>r.json()).then(res => {
      allCustomerIds = res.ids || [];
      document.getElementById('idList').innerHTML = allCustomerIds.map(id => `<option value="${esc(id)}">`).join('');
    });

    // --- åˆ‡æ›ä»‹é¢ ---
    document.getElementById('login').style.display = 'none';
    document.getElementById('adminNav').style.display = 'grid';
    document.getElementById('mainPanel').style.display = 'block';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('arrivalDateInput').value = today;
    document.getElementById('addDate').value = today;

    // --- é€™è£¡åŸ·è¡Œä¸€æ¬¡å°±å¤ äº† ---
    setFilter('todo'); 
    buildArrivalTabs();
  })
  .catch(err => { 
    document.getElementById('loginStatus').textContent = 'å¯†ç¢¼éŒ¯èª¤æˆ–é€£ç·šå¤±æ•—'; 
  });
}

async function render() {
  const listEl = document.getElementById('list');
  listEl.innerHTML = '';

  let items = allItems.filter(i => {
    if (currentFilter === 'unrated') return String(i.status).trim() === 'æœªè©•åƒ¹';
    if (currentFilter === 'done') return !!i.image && !i.status;
    if (currentFilter === 'todo') return !i.image;
    return true;
  }).filter(i => {
    const arr = String(i.arrival || '').trim();
    return (currentArrival === 'æœªåˆ°è²¨') ? (!arr) : (arr === currentArrival);
  });
  
  if (currentFilter === 'unrated' && items.length > 0) {
    const batchBtn = document.createElement('button');
    batchBtn.innerHTML = `âœ… ä¸€éµå®Œæˆæœ¬é æ‰€æœ‰è©•åƒ¹ (${items.length} é …)`;
    batchBtn.style.cssText = "width:100%; padding:15px; background:#059669; color:white; border:none; border-radius:12px; font-weight:bold; margin-bottom:15px;";
    batchBtn.onclick = () => submitAllEvaluations();
    listEl.appendChild(batchBtn);
  }
  
  for (const it of items) {
    const isPending = pendingUpdates.has(it.row);
    const pData = pendingUpdates.get(it.row) || {};
    const displayImg = pData.image !== undefined ? pData.image : it.image;
    const displayWeight = pData.weight !== undefined ? pData.weight : (it.weight || '');
    const displayId = pData.custId !== undefined ? pData.custId : (it.custId || '');
    const displayPos = pData.position !== undefined ? pData.position : (it.position || '');
    const displayLink = pData.link !== undefined ? pData.link : (it.link || '');
    const displayTrack = pData.track !== undefined ? pData.track : (it.track || '');

    const isUnratedMode = (currentFilter === 'unrated');
    let finalLink = displayLink;
    if (isUnratedMode && finalLink && finalLink.includes('mercari.com/item/')) {
      finalLink = finalLink.replace('/item/', '/transaction/');
    }

    const shouldLock = (it.position || it.custId) && !editingRows.has(it.row) && !isPending;
    const card = document.createElement('div');
    card.className = `card-fixed ${isPending ? 'pending-card' : ''}`;
    
    let finalImgHtml = `<div style="line-height:90px; color:#ccc; font-size:12px;">ç„¡åœ–</div>`;
    if (displayImg) {
      finalImgHtml = `<img src="${escAttr(displayImg)}" class="card-img">`;
    } else if (finalLink && finalLink.startsWith('http')) {
      const cacheImg = urlPreviewCache.get(finalLink);
      if (cacheImg) {
        finalImgHtml = `<img src="${escAttr(cacheImg)}" class="card-img"><div class="preview-label">ç¶²å€é è¦½</div>`;
      } else {
        finalImgHtml = `<div id="img-load-${it.row}" style="line-height:90px; color:#3b82f6; font-size:10px;">æŠ“å–ä¸­...</div>`;
        fetchPreview(finalLink, it.row);
      }
    }

    let posAndIdHtml = shouldLock ? 
      `<div style="display: flex; align-items: center; gap: 10px; margin-top: 5px; background: #f1f5f9; padding: 8px; border-radius: 8px;">
          <div style="font-size: 13px; font-weight: bold; color: #1e293b;">ğŸ“ ${esc(displayPos)}</div>
          <div style="font-size: 13px; color: #94a3b8; flex: 1;">ID: ${esc(displayId)}</div>
          <button onclick="editingRows.add(${it.row}); render();" style="padding:4px 8px; font-size:11px; background:#fff; border:1px solid #cbd5e1; border-radius:4px;">âœï¸</button>
       </div>` :
      `<div class="pos-label">Position:</div>
       <div class="pos-group">${Object.keys(POS_MAP).map(k => `<button class="pos-btn ${displayPos === POS_MAP[k] ? 'selected' : ''}" onclick="updateField(${it.row}, 'position', '${POS_MAP[k]}')">${k}</button>`).join('')}</div>
       <input type="text" list="idList" class="id-input" placeholder="Customer ID" value="${esc(displayId)}" oninput="updateField(${it.row}, 'custId', this.value, true)">`;

    card.innerHTML = `
      <div class="card-left">
        <div class="code-tag">${esc(it.code || 'ç„¡ç·¨è™Ÿ')}</div>
        <div style="font-size: 11px; color: #64748b; margin-bottom: 6px;">ğŸ“… åˆ°è²¨æ—¥æœŸ: <span style="font-weight:bold;">${it.arrivalDate || 'æœªå¡«'}</span></div>
        ${posAndIdHtml}
        <div class="weight-row">
          <input type="number" id="w_inp_${it.row}" inputmode="decimal" step="0.001" class="weight-input" value="${displayWeight}" oninput="updateField(${it.row}, 'weight', this.value, true)">
          <span class="weight-unit">kg</span>
        </div>
        <div style="margin-top: 8px;">
          ${displayTrack ? `<span class="green-tag" onclick="editPrompt(${it.row}, 'track', '${esc(displayTrack)}')">${esc(displayTrack)}</span>` : `<span style="font-size:11px; color:#94a3b8; cursor:pointer;" onclick="editPrompt(${it.row}, 'track', '')">+ é‹å–®</span>`}
        </div>
        ${isUnratedMode ? `<button onclick="submitEvaluationComplete(${it.row})" style="width:100%; margin-top:10px; padding:12px; background:#059669; color:white; border:none; border-radius:8px; font-weight:bold;">âœ… å·²å®Œæˆè©•åƒ¹</button>` : ''}
      </div>
      <div class="card-right">
        <div class="card-img-wrap" id="img-wrap-${it.row}">${finalImgHtml}</div>
        <div style="display:flex; gap:4px; justify-content:center">
          <button class="photo-btn" onclick="triggerUpload(${it.row}, 'cam')">ğŸ“·</button>
          <button class="photo-btn" onclick="triggerUpload(${it.row}, 'gal')">ğŸ–¼ï¸</button>
        </div>
        <input type="file" id="file-${it.row}" accept="image/*" style="display:none">
        <div id="st-${it.row}" style="font-size:10px; margin-top:4px; color:#64748b;">${isPending ? 'â³ å¾…å„²å­˜' : ''}</div>
      </div>
    `;
    listEl.appendChild(card);
  }
}

async function submitAllEvaluations() {
  if(!confirm('ç¢ºå®šè¦å°‡æ­¤é é¢æ‰€æœ‰å•†å“æ¨™è¨˜ç‚ºã€Œå·²è©•åƒ¹ã€å—ï¼Ÿ')) return;
  const btn = event.target;
  const originalText = btn.textContent;
  btn.disabled = true; btn.textContent = 'å¤§è¦æ¨¡è™•ç†ä¸­...';
  try {
    const res = await fetch(API, { method: 'POST', body: new URLSearchParams({ action: 'clearAllUnrated', password }) });
    const data = await res.json();
    if (data.success) {
      alert(`æˆåŠŸè™•ç†ï¼å…±æ¸…é™¤ ${data.count || 0} é …æ¨™è¨˜ã€‚`);
      allItems.forEach(it => { if(it.status === 'æœªè©•åƒ¹') it.status = ''; });
      render();
    } else { alert('å¤±æ•—ï¼š' + data.error); }
  } catch (e) { alert('ç³»çµ±é€£ç·šå¤±æ•—'); }
  finally { btn.disabled = false; btn.textContent = originalText; }
}

async function submitEvaluationComplete(row) {
  const btn = event.target;
  btn.disabled = true; btn.textContent = 'è™•ç†ä¸­...';
  try {
    const res = await fetch(API, { method: 'POST', body: new URLSearchParams({ action: 'saveArrivalData', password, row, status: '' }) });
    const data = await res.json();
    if(data.success || data.items) {
      const item = allItems.find(i => i.row === row);
      if(item) item.status = '';
      render();
    }
  } catch(e) { alert('å¤±æ•—'); btn.disabled = false; btn.textContent = 'âœ… å·²å®Œæˆè©•åƒ¹'; }
}

async function fetchPreview(url, row) {
  if (urlPreviewCache.has(url)) {
    updateImgWrap(row, urlPreviewCache.get(url));
    return;
  }

  const mId = url.match(/item\/(m\d+)/);
  if (mId && mId[1]) {
    const mercariImg = `https://static.mercdn.net/item/detail/orig/photos/${mId[1]}_1.jpg`;
    // å…ˆå­˜å†æ›´æ–°ï¼Œç¢ºä¿é‚è¼¯é€£è²«
    saveToCache(url, mercariImg);
    updateImgWrap(row, mercariImg);
    return;
  }

  // å¦‚æœå·²ç¶“æ˜¯ Mercari å°±ä¸æœƒåŸ·è¡Œåˆ°é€™è£¡
  setTimeout(async () => {
    try {
      if (!url.startsWith('http')) return;
      const res = await fetch(`https://api.linkpreview.net/?key=${LINK_PREVIEW_KEY}&q=${encodeURIComponent(url)}`);
      const data = await res.json();
      if (data && data.image) {
        saveToCache(url, data.image);
        updateImgWrap(row, data.image);
      } else {
        throw new Error('No image');
      }
    } catch (e) { 
      const loader = document.getElementById(`img-load-${row}`);
      if(loader) loader.textContent = 'ç„¡é è¦½';
    }
  }, Math.random() * 2000); 
}

function saveToCache(url, imgData) {
  try {
    urlPreviewCache.set(url, imgData);
    const cacheArray = Array.from(urlPreviewCache.entries());
    
    // å¦‚æœå¿«å–è¶…é 400 ç­†ï¼Œåˆªé™¤èˆŠçš„ï¼Œé¿å… LocalStorage çˆ†æ‰
    if (cacheArray.length > 400) {
      const slimCache = cacheArray.slice(-400);
      localStorage.setItem('img_cache', JSON.stringify(slimCache));
    } else {
      localStorage.setItem('img_cache', JSON.stringify(cacheArray));
    }
  } catch(e) { 
    console.warn("LocalStorage ç©ºé–“ä¸è¶³ï¼Œæ¸…é™¤èˆŠå¿«å–");
    localStorage.removeItem('img_cache'); // å¦‚æœçœŸçš„çˆ†äº†ï¼Œæ¸…ç©ºé‡ä¾†
    urlPreviewCache.clear();
  }
}

function updateImgWrap(row, imgSrc) {
  const wrap = document.getElementById(`img-wrap-${row}`);
  if (wrap) wrap.innerHTML = `<img src="${escAttr(imgSrc)}" class="card-img"><div class="preview-label">ç¶²å€é è¦½</div>`;
}

function editPrompt(row, field, oldVal) {
  const newVal = prompt(`ä¿®æ”¹ ${field === 'link' ? 'å•†å“ç¶²å€' : 'é‹å–®ç·¨è™Ÿ'}:`, oldVal);
  if (newVal !== null) updateField(row, field, newVal);
}

function updateField(row, field, value, isTyping = false) {
  let data = pendingUpdates.get(row) || {};
  data[field] = value;
  pendingUpdates.set(row, data);
  editingRows.add(row);
  if (isTyping) {
    updateUIStates();
    const stEl = document.getElementById('st-' + row);
    if (stEl) stEl.textContent = 'â³ å¾…å„²å­˜';
  } else { render(); updateUIStates(); }
}

async function saveBatchData() {
  if (pendingUpdates.size === 0) return;
  if (!confirm("ç¢ºå®šå„²å­˜å…¨éƒ¨ä¿®æ”¹ï¼Ÿ")) return;
  const btn = document.querySelector('#batchBar button[onclick="saveBatchData()"]');
  const floatBtn = document.getElementById('floatingSave');
  const originalBtnText = btn ? btn.textContent : 'ğŸ’¾ å„²å­˜å…¨éƒ¨';
  if (btn) { btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­...'; }
  if (floatBtn) floatBtn.disabled = true;
  const dateVal = document.getElementById('arrivalDateInput').value.replace(/-/g, '/');
  
  const tasks = Array.from(pendingUpdates.entries()).map(([row, data]) => {
    const params = { action: 'saveArrivalData', password, row };
    const hasWeight = data.weight !== undefined && data.weight.toString().trim() !== "";
    if (data.position !== undefined) params.position = data.position;
    if (data.custId !== undefined) params.custId = data.custId;
    if (data.weight !== undefined) params.weight = data.weight;
    if (data.image !== undefined) params.image = data.image;
    if (data.track !== undefined) params.track = data.track;
    if (hasWeight) { params.arrivalDate = dateVal; params.shipDate = dateVal; params.status = 'æœªè©•åƒ¹'; }
    return fetch(API, { method:'POST', body: new URLSearchParams(params) }).then(r => r.json());
  });

  try {
    const results = await Promise.all(tasks);
    const refreshRes = await fetch(API, { method: 'POST', body: new URLSearchParams({action:'getAdminItems', password}) });
    const refreshData = await refreshRes.json();
    if(refreshData.items) {
      allItems = refreshData.items;
      pendingUpdates.clear(); editingRows.clear();
      updateLatestShipDate(); render(); updateUIStates();
      alert('å„²å­˜æˆåŠŸï¼');
    }
  } catch (err) { alert('å„²å­˜å¤±æ•—'); }
  finally { if (btn) { btn.disabled = false; btn.textContent = originalBtnText; } if (floatBtn) floatBtn.disabled = false; }
}

function triggerUpload(row, mode) {
  const inp = document.getElementById('file-' + row);
  if(mode === 'cam') inp.setAttribute('capture', 'environment'); else inp.removeAttribute('capture');
  inp.onchange = async () => {
    if(!inp.files[0]) return;
    document.getElementById('st-' + row).textContent = 'ä¸Šå‚³ä¸­...';
    try {
      const url = await compressAndUpload(inp.files[0]);
      updateField(row, 'image', url);
    } catch(e) { document.getElementById('st-' + row).textContent = 'âŒ å¤±æ•—'; }
  };
  inp.click();
}

function updateUIStates() {
  const count = pendingUpdates.size;
  document.getElementById('batchBar').style.display = count > 0 ? 'block' : 'none';
  document.getElementById('floatingSave').style.display = count > 0 ? 'flex' : 'none';
  document.getElementById('pendingMsg').textContent = `ğŸ“ ${count} é …å¾…å„²å­˜`;
}

function clearPendingUpdates() { if (confirm("ç¢ºå®šæ¸…é™¤ï¼Ÿ")) { pendingUpdates.clear(); editingRows.clear(); render(); updateUIStates(); } }

function buildArrivalTabs(){
  const tabs = document.getElementById('arrivalTabs'); tabs.innerHTML = '';
  let arrivals = [...new Set(allItems.map(i=>i.arrival).filter(a=>a))].sort((a,b)=>groupNum(b)-groupNum(a));
  ['æœªåˆ°è²¨', ...arrivals.slice(0,4)].forEach(name => {
    const t = document.createElement('div');
    t.style.cssText = `padding:8px 15px; border-radius:20px; background:${currentArrival===name?'#2563eb':'#fff'}; color:${currentArrival===name?'#fff':'#475569'}; border:1px solid #ddd; cursor:pointer; font-size:13px; font-weight:bold; white-space:nowrap;`;
    t.textContent = name;
    t.onclick = () => { currentArrival = name; render(); buildArrivalTabs(); };
    tabs.appendChild(t);
  });
}

function groupNum(str){ const m = String(str||'').match(/\d+/); return m ? parseInt(m[0],10) : -1; }

async function compressAndUpload(file) {
  return new Promise((resolve, reject) => {
    const img = new Image(); const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas'); const max = 1000;
      let w = img.width, h = img.height;
      if (w > h && w > max) { h *= max/w; w = max; } else if (h > max) { w *= max/h; h = max; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => {
        const fd = new FormData(); fd.append('file', blob); fd.append('upload_preset', UPLOAD_PRESET); fd.append('folder', CLOUD_FOLDER);
        fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method:'POST', body:fd }).then(r=>r.json()).then(res=>resolve(res.secure_url)).catch(reject);
      }, 'image/jpeg', 0.7);
    };
    reader.readAsDataURL(file);
  });
}
function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escAttr(s){ return esc(s).replace(/\n/g,' '); }
function openAddModal() { document.getElementById('addModal').style.display = 'flex'; }
function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }

async function submitNewItem() {
  const btn = document.getElementById('submitAddBtn');
  const payload = {
    action: 'addNewItem', password,
    date: document.getElementById('addDate').value.replace(/-/g, '/'),
    shop: document.getElementById('addShop').value,
    link: document.getElementById('addLink').value.trim(),
    item: document.getElementById('addItem').value.trim(),
    jpy: document.getElementById('addJpy').value,
    pos: document.getElementById('addPos').value.trim(),
    id: document.getElementById('addCustId').value.trim()
  };
  if (!payload.item || !payload.shop || !payload.pos) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
  btn.disabled = true; btn.textContent = 'è™•ç†ä¸­...';
  try {
    const res = await fetch(API, { method: 'POST', body: new URLSearchParams(payload) });
    const data = await res.json();
    if (data.success) { alert('æˆåŠŸï¼'); closeAddModal(); doLogin(); } else { alert('å‡ºéŒ¯'); }
  } catch (e) { alert('å¤±æ•—'); }
  finally { btn.disabled = false; btn.textContent = 'ç¢ºå®šåŠ å…¥'; }
}
</script>
</body>
</html>
