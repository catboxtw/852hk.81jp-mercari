<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ‡¯ğŸ‡µMercariä»£è³¼-ç®¡ç†å“¡å¾Œå°</title>
<link rel="stylesheet" href="style.css?v=20251225-3">
<style>
  /* é‡å°ç®¡ç†å¾Œå°çš„é¡å¤–è¨­è¨ˆ */
  :root {
    --primary-color: #2563eb;
    --bg-light: #f8fafc;
  }

  .admin-wrap { max-width: 1000px; margin: 0 auto; padding: 20px; }
  
  /* å°èˆªæŒ‰éˆ•æ¨£å¼ */
  .admin-nav {
    display: none; /* ç™»å…¥å¾Œé¡¯ç¤º */
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 25px;
  }
  @media (min-width: 600px) { .admin-nav { grid-template-columns: repeat(4, 1fr); } }

  .nav-btn {
    padding: 15px 10px;
    border: none;
    border-radius: 8px;
    background: #fff;
    color: #475569;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
    border: 2px solid transparent;
  }

  .nav-btn.active {
    background: var(--primary-color);
    color: #fff;
    border-color: var(--primary-color);
  }

  .nav-btn:hover:not(.active) { border-color: #cbd5e1; }

  .nav-btn span { font-size: 20px; } /* åœ–ç¤ºç¬¦è™Ÿ */

  /* ç‰ˆé¢å®¹å™¨ */
  .tab-content { display: none; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
  .tab-content.active { display: block; }

  /* ç™»å…¥ä»‹é¢ç¾åŒ– */
  .admin-login {
    background: #fff;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    max-width: 400px;
    margin: 50px auto;
    text-align: center;
  }
  .admin-login input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; }
  
  .placeholder-view { padding: 40px; text-align: center; color: #94a3b8; }
</style>
</head>

<body>
<main class="admin-wrap">

  <div style="text-align: center; margin-bottom: 20px;">
    <h1>ç®¡ç†å“¡å¾Œå°</h1>
  </div>

  <div id="login" class="admin-login">
    <h3>èº«åˆ†é©—è­‰</h3>
    <input id="pw" type="password" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" autocomplete="current-password">
    <button id="loginBtn" type="button" style="width: 100%;">é€²å…¥ç®¡ç†ç³»çµ±</button>
    <div id="loginStatus" class="muted" style="margin-top:10px;"></div>
  </div>

  <div id="adminNav" class="admin-nav" style="display:none;">
    <button class="nav-btn" onclick="location.href='id-search.html'">
      <span>ğŸ”</span>æŸ¥è©¢ ID
    </button>
    <button class="nav-btn active" data-tab="arrivalSection" onclick="switchTab(this)">
      <span>âš–ï¸</span>åˆ°è²¨ç£…é‡
    </button>
    <button class="nav-btn" data-tab="pickingSection" onclick="switchTab(this)">
      <span>ğŸ“¦</span>åŸ·è²¨
    </button>
    <button class="nav-btn" data-tab="notifySection" onclick="switchTab(this)">
      <span>ğŸ“¢</span>é€šçŸ¥å®¢äºº
    </button>
  </div>

  <div id="mainPanel" style="display:none">
    
    <div id="arrivalSection" class="tab-content active">
      <div class="filter">
        <button type="button" data-filter="todo">æœªå®Œæˆ</button>
        <button type="button" data-filter="done">å·²å®Œæˆ</button>
        <button type="button" data-filter="all">å…¨éƒ¨</button>
      </div>
      <div id="arrivalTabs" class="tabs"></div>
      <div id="list"></div>
    </div>

    <div id="pickingSection" class="tab-content">
      <div class="placeholder-view">
        <h3>ğŸ“¦ åŸ·è²¨åŠŸèƒ½é–‹ç™¼ä¸­</h3>
        <p>æ­¤è™•å°‡åˆ—å‡ºå·²åˆ°è²¨è¨‚å–®ï¼Œæ–¹ä¾¿æ‚¨é€²è¡ŒåŸ·è²¨èˆ‡ä½ç½®åˆ†é…ã€‚</p>
      </div>
    </div>

    <div id="notifySection" class="tab-content">
      <div class="placeholder-view">
        <h3>ğŸ“¢ é€šçŸ¥åŠŸèƒ½é–‹ç™¼ä¸­</h3>
        <p>æ­¤è™•å°‡è‡ªå‹•ç¯©é¸å·²åŸ·è²¨ä½†æœªé€šçŸ¥çš„å®¢äººï¼Œä¸¦æä¾›ä¸€éµé€šçŸ¥åŠŸèƒ½ã€‚</p>
      </div>
    </div>

  </div>

</main>

<datalist id="id-list"></datalist>
<datalist id="pos-list"></datalist>

<script>
// --- åˆ†é åˆ‡æ›é‚è¼¯ ---
function switchTab(btn) {
  const targetId = btn.getAttribute('data-tab');
  if (!targetId) return;

  // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  // åˆ‡æ›ç‰ˆé¢é¡¯ç¤º
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.getElementById(targetId).classList.add('active');
}

document.addEventListener('DOMContentLoaded', () => {
  // ä½ çš„ API ç¶²å€
  const API = 'https://script.google.com/macros/s/AKfycby2I6Q2M67npEFW-Vqi14JS3L7rtuQ9DLD35KwhwCaGpyt3xBnRfNyeLcOGXfslA9sx/exec';

  const CLOUD_NAME = 'disr3dmsj';
  const UPLOAD_PRESET = 'mercariup';
  const CLOUD_FOLDER = 'mercari';

  let password = '';
  let allItems = [];
  let currentFilter = 'todo';
  let currentArrival = 'æœªåˆ°è²¨';

  const loginBtn = document.getElementById('loginBtn');
  const loginStatusEl = document.getElementById('loginStatus');
  const arrivalTabsEl = document.getElementById('arrivalTabs');
  const listEl = document.getElementById('list');
  const idListEl = document.getElementById('id-list');
  const posListEl = document.getElementById('pos-list');

  loginBtn.addEventListener('click', doLogin);
  document.getElementById('pw').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doLogin(); });

  // åŸæœ¬çš„ç¯©é¸æŒ‰éˆ•äº‹ä»¶
  document.querySelectorAll('.filter button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      currentFilter = btn.dataset.filter;
      render();
    });
  });

  function doLogin(){
    password = (document.getElementById('pw').value || '').trim();
    if(!password){ loginStatusEl.textContent='è«‹è¼¸å…¥å¯†ç¢¼'; return; }

    loginStatusEl.textContent='é©—è­‰ä¸­â€¦';
    loginBtn.disabled = true;

    const body = new URLSearchParams();
    body.append('action','getAdminItems');
    body.append('password',password);

    fetch(API,{method:'POST',body})
      .then(r=>r.json())
      .then(d=>{
        if(d.error) throw new Error(d.error);

        localStorage.setItem('adminPw', password);
        allItems = Array.isArray(d.items) ? d.items : [];
        allItems = allItems.filter(it => String(it.item||'').trim());

        buildDatalists();
        buildArrivalTabs();

        // æˆåŠŸç™»å…¥å¾Œçš„åˆ‡æ›
        document.getElementById('login').style.display='none';
        document.getElementById('adminNav').style.display='grid'; // é¡¯ç¤ºå°èˆª
        document.getElementById('mainPanel').style.display='block'; // é¡¯ç¤ºé¢æ¿å®¹å™¨
        loginStatusEl.textContent='';
        render();
      })
      .catch(err=>{
        console.error(err);
        loginStatusEl.textContent='å¯†ç¢¼éŒ¯èª¤æˆ–ç³»çµ±ç•°å¸¸';
      })
      .finally(()=> loginBtn.disabled=false);
  }

  // --- ä»¥ä¸‹ä¿ç•™ä½ åŸæœ¬çš„æ‰€æœ‰æ ¸å¿ƒ function (buildDatalists, buildArrivalTabs, render, ç­‰ç­‰) ---
  // (ç‚ºäº†ç¯‡å¹…ï¼Œæ­¤è™•çœç•¥ä¸­é–“é‡è¤‡çš„é‚è¼¯ä»£ç¢¼ï¼Œè«‹ä¿ç•™ä½ åŸä»£ç¢¼ä¸­å¾ function buildDatalists é–‹å§‹åˆ°çµå°¾çš„æ‰€æœ‰ JS ä»£ç¢¼)
  
  function buildDatalists(){
    const ids = [...new Set(allItems.map(i=>String(i.custId||'').trim()).filter(Boolean))].sort();
    const poss = [...new Set(allItems.map(i=>String(i.position||'').trim()).filter(Boolean))].sort();
    idListEl.innerHTML = ids.map(v=>`<option value="${escAttr(v)}"></option>`).join('');
    posListEl.innerHTML = poss.map(v=>`<option value="${escAttr(v)}"></option>`).join('');
  }

  function buildArrivalTabs(){
    arrivalTabsEl.innerHTML='';
    let arrivals=[...new Set(allItems.map(i=>i.arrival).filter(a=>a && String(a).trim()))];
    arrivals.sort((a,b)=>groupNum(b)-groupNum(a));
    const show=['æœªåˆ°è²¨', ...arrivals.slice(0,3)];
    const more=arrivals.slice(3);
    show.forEach(name=>{
      const t=document.createElement('div');
      t.className='tab';
      t.textContent=name;
      t.onclick=()=>{ currentArrival=name; render(); };
      arrivalTabsEl.appendChild(t);
    });
    if(more.length){
      const moreTab=document.createElement('div');
      moreTab.className='tab more';
      moreTab.textContent='...';
      const list=document.createElement('div');
      list.className='more-list';
      more.forEach(name=>{
        const d=document.createElement('div');
        d.textContent=name;
        d.onclick=()=>{ currentArrival=name; render(); list.style.display='none'; };
        list.appendChild(d);
      });
      moreTab.appendChild(list);
      moreTab.addEventListener('click', ()=>{
        list.style.display = (list.style.display==='block') ? 'none' : 'block';
      });
      arrivalTabsEl.appendChild(moreTab);
    }
  }

  function render(){
    listEl.innerHTML='';
    let items=[...allItems];
    if(currentFilter==='todo') items = items.filter(i=>!i.image);
    if(currentFilter==='done') items = items.filter(i=>!!i.image);
    if(currentArrival==='æœªåˆ°è²¨'){
      items = items.filter(i=>!i.arrival || !String(i.arrival).trim());
    }else{
      items = items.filter(i=>String(i.arrival).trim()===String(currentArrival).trim());
    }

    items.forEach(it=>{
      const w=parseFloat(it.weight)||0;
      const needMeta = !(String(it.position||'').trim() && String(it.custId||'').trim());
      const card=document.createElement('div');
      card.className='card-fixed';
      card.innerHTML=`
        <div class="card-left">
          ${it.code ? `<div class="code">${esc(it.code)}</div>` : ''}
          <div>${esc(it.item||'')}</div>
          ${it.link ? `<div class="item-link"><a href="${escAttr(it.link)}" target="_blank" rel="noopener">${esc(it.link)}</a></div>` : `<div class="item-link muted">ï¼ˆæœªæœ‰ Linkï¼‰</div>`}
          <div class="muted">åˆ°è²¨æ—¥æœŸï¼š${esc(it.arrivalDate||'â€”')}</div>
          ${needMeta ? `
              <div class="meta-edit">
                <input class="pos" list="pos-list" placeholder="Position" value="${escAttr(it.position||'')}">
                <input class="cid" list="id-list" placeholder="ID" value="${escAttr(it.custId||'')}">
                <button class="save-btn" type="button">å„²å­˜</button>
                <div class="status muted"></div>
              </div>
            ` : `
              <div>ä½ç½®: ${esc(it.position||'')}</div>
              <div>å®¢æˆ¶ ID: ${esc(it.custId||'')}</div>
            `
          }
        </div>
        <div class="card-right">
          <div class="card-img-wrap">
            ${it.image ? `<img class="card-img" src="${escAttr(it.image)}" alt="">` : `<div class="card-img-placeholder">No Image</div>`}
          </div>
          <div class="card-weight">${w>0 ? `${w.toFixed(3)} kg` : ''}</div>
          <div class="photo-actions">
            <button class="photo-btn cam" type="button">ç«‹å³æ‹ç…§</button>
            <button class="photo-btn gal" type="button">æ–°å¢ç…§ç‰‡</button>
          </div>
          <div class="upload-status"></div>
          <input class="file" type="file" accept="image/*" style="display:none">
        </div>
      `;

      const file = card.querySelector('.file');
      const status = card.querySelector('.upload-status');
      const imgWrap = card.querySelector('.card-img-wrap');

      card.querySelector('.cam').onclick = ()=>{ file.setAttribute('capture','environment'); file.click(); };
      card.querySelector('.gal').onclick = ()=>{ file.removeAttribute('capture'); file.click(); };

      file.onchange = ()=>{
        const f = file.files && file.files[0];
        if(!f) return;
        status.textContent='ä¸Šå‚³ä¸­â€¦';
        compressAndUpload(f)
          .then(url => saveImageToSheet(it.row, url).then(()=>url))
          .then(url=>{
            it.image = url;
            imgWrap.innerHTML = `<img class="card-img" src="${escAttr(url)}" alt="">`;
            status.textContent='ä¸Šå‚³æˆåŠŸ';
          })
          .catch(err=>{ status.textContent='ä¸Šå‚³å¤±æ•—'; });
      };

      if(needMeta){
        const saveBtn = card.querySelector('.save-btn');
        saveBtn.onclick = ()=>{
          const position=card.querySelector('.pos').value.trim();
          const custId=card.querySelector('.cid').value.trim();
          if(!position || !custId){ card.querySelector('.status').textContent='è«‹è¼¸å…¥ Position åŠ ID'; return; }
          card.querySelector('.status').textContent='å„²å­˜ä¸­â€¦';
          savePositionId(it.row, position, custId).then(()=>{
            it.position = position; it.custId = custId;
            buildDatalists();
            card.querySelector('.status').textContent='å„²å­˜æˆåŠŸ';
            setTimeout(()=>render(), 80);
          });
        };
      }
      listEl.appendChild(card);
    });
  }

  function groupNum(str){ const m = String(str||'').match(/\d+/); return m ? parseInt(m[0],10) : -1; }
  function saveImageToSheet(row, imageUrl){
    const body = new URLSearchParams();
    body.append('action','saveImage');
    body.append('password',password);
    body.append('row',String(row));
    body.append('image',imageUrl);
    return fetch(API,{method:'POST',body}).then(r=>r.json()).then(d=>{ if(d.error) throw new Error(d.error); return true; });
  }
  function savePositionId(row, position, custId){
    const body = new URLSearchParams();
    body.append('action','savePositionId');
    body.append('password',password);
    body.append('row',String(row));
    body.append('position',position);
    body.append('custId',custId);
    return fetch(API,{method:'POST',body}).then(r=>r.json()).then(d=>{ if(d.error) throw new Error(d.error); return true; });
  }
  function compressAndUpload(file){
    return new Promise((resolve,reject)=>{
      const img=new Image();
      const reader=new FileReader();
      reader.onload=e=>img.src=e.target.result;
      img.onload=()=>{
        const canvas=document.createElement('canvas');
        const max=1200;
        let w=img.width, h=img.height;
        if(w>h && w>max){ h=h*(max/w); w=max; }
        else if(h>max){ w=w*(max/h); h=max; }
        canvas.width=w; canvas.height=h;
        canvas.getContext('2d').drawImage(img,0,0,w,h);
        canvas.toBlob(blob=>{
          const fd=new FormData();
          fd.append('file',blob);
          fd.append('upload_preset',UPLOAD_PRESET);
          fd.append('folder',CLOUD_FOLDER);
          fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:'POST',body:fd})
            .then(r=>r.json()).then(res=>resolve(res.secure_url)).catch(reject);
        },'image/jpeg',0.75);
      };
      reader.readAsDataURL(file);
    });
  }
  function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function escAttr(s){ return esc(s).replace(/\n/g,' '); }
});
</script>
</body>
</html>
