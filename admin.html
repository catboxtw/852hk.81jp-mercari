<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
<title>ğŸ‡¯ğŸ‡µç®¡ç†å“¡å¾Œå°</title>
<style>
  :root { --primary-color: #2563eb; --bg-light: #f8fafc; --warn-color: #f57c00; }
  * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
  body { background: var(--bg-light); margin: 0; padding: 0; font-family: -apple-system, sans-serif; overflow-x: hidden; }
  .admin-wrap { max-width: 1000px; margin: 0 auto; padding: 15px; padding-bottom: 100px; }
  
  /* ç™»å…¥ä»‹é¢ */
  .admin-login { background: #fff; padding: 30px 20px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 95%; max-width: 350px; margin: 60px auto; text-align: center; }
  input, button { font-size: 16px !important; -webkit-appearance: none; }

  /* å°èˆªèˆ‡éæ¿¾æŒ‰éˆ• */
  .admin-nav { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
  .nav-btn { padding: 12px 5px; border-radius: 10px; background: #fff; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; gap: 5px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
  .nav-btn.active { background: var(--primary-color); color: #fff; }

  .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; }
  .filter-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; background: #fff; cursor: pointer; font-weight: bold; color: #475569; }
  .filter-btn.active { background: #e2e8f0; border-color: #94a3b8; color: #1e293b; }

  /* å•†å“å¡ç‰‡ */
  .card-fixed { display: flex; background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 2px solid transparent; position: relative; }
  .pending-card { border-color: var(--warn-color) !important; background: #fffaf5 !important; }
  .code-tag { background: #475569; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 6px; }

  .card-left { flex: 1; padding-right: 10px; }
  .card-right { width: 90px; text-align: center; flex-shrink: 0; }
  .weight-input { width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 8px; margin-top: 10px; }

  /* Position æŒ‰éˆ•çµ„ */
  .pos-group { display: flex; gap: 4px; margin-top: 8px; flex-wrap: wrap; }
  .pos-btn { flex: 1; min-width: 45px; padding: 6px 2px; border: 1px solid #cbd5e1; background: #fff; border-radius: 6px; font-size: 11px; cursor: pointer; color: #475569; }
  .pos-btn.selected { background: #fee2e2; border-color: #ef4444; color: #b91c1c; font-weight: bold; box-shadow: 0 0 0 1px #ef4444; }

  /* ID è¼¸å…¥æ¡† */
  .id-input { width: 100%; padding: 8px; border: 2px solid #cbd5e1; border-radius: 8px; margin-top: 5px; font-size: 14px; }

  .card-img-wrap { width: 85px; height: 85px; background: #f1f5f9; border-radius: 8px; overflow: hidden; margin-bottom: 8px; }
  .card-img { width: 100%; height: 100%; object-fit: cover; }
  .photo-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }

  #batchBar { display: none; background: #fff4e5; border: 1px solid #ffe0b2; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  #floatingSave { display: none; position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px; border-radius: 50%; background: var(--warn-color); color: white; border: none; font-size: 30px; z-index: 101; box-shadow: 0 4px 15px rgba(0,0,0,0.3); align-items: center; justify-content: center; }
</style>
</head>

<body>
<datalist id="idList"></datalist>

<main class="admin-wrap">
  <div style="text-align: center; margin-bottom: 20px;"><h2>ç®¡ç†å“¡å¾Œå°</h2></div>

  <div id="login" class="admin-login">
    <h3 style="margin-top:0">èº«åˆ†é©—è­‰</h3>
    <input id="pw" type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:2px solid #ddd;">
    <button id="loginBtn" onclick="doLogin()" style="width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight:bold;">é€²å…¥ç®¡ç†ç³»çµ±</button>
    <div id="loginStatus" style="margin-top:10px; color: #64748b;"></div>
  </div>

  <div id="adminNav" class="admin-nav" style="display:none;">
    <button class="nav-btn" onclick="location.href='id-search.html'"><span>ğŸ”</span>æŸ¥è©¢ ID</button>
    <button class="nav-btn active"><span>âš–ï¸</span>åˆ°è²¨ç£…é‡</button>
    <button class="nav-btn" onclick="alert('é–‹ç™¼ä¸­')"><span>ğŸ“¦</span>åŸ·è²¨</button>
    <button class="nav-btn" onclick="alert('é–‹ç™¼ä¸­')"><span>ğŸ“¢</span>é€šçŸ¥å®¢äºº</button>
  </div>

  <div id="batchBar" style="position: relative;">
    <button onclick="clearPendingUpdates()" style="position: absolute; top: 5px; right: 5px; background: none; border: none; color: #94a3b8; font-size: 18px; cursor: pointer; padding: 5px; line-height: 1;">âœ•</button>
    <div style="margin-bottom: 10px; border-bottom: 1px dashed #ffe0b2; padding-bottom: 8px; padding-right: 20px;">
      <label style="font-size: 12px; color: #e65100; font-weight: bold; display: block; margin-bottom: 4px;">ğŸ“… åˆ°è²¨æ—¥æœŸ (Pæ¬„ Arrival date):</label>
      <input type="date" id="arrivalDateInput" style="width: 100%; padding: 8px; border: 1px solid #ffcc80; border-radius: 6px; font-size: 16px;">
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <span id="pendingMsg" style="color: #e65100; font-weight: bold;">ğŸ“ 0 é …å¾…å„²å­˜</span>
      <button onclick="saveBatchData()" style="background:#f57c00; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold;">ğŸ’¾ å„²å­˜å…¨éƒ¨</button>
    </div>
  </div>

  <div id="mainPanel" style="display:none">
    <div class="filter-bar">
      <button class="filter-btn" id="f-todo" onclick="setFilter('todo')">æœªå®Œæˆ</button>
      <button class="filter-btn" id="f-done" onclick="setFilter('done')">å·²å®Œæˆ</button>
      <button class="filter-btn" id="f-all" onclick="setFilter('all')">å…¨éƒ¨</button>
    </div>
    <div id="arrivalTabs" style="display:flex; gap:8px; margin-bottom:15px; overflow-x:auto; padding-bottom:5px;"></div>
    <div id="list"></div>
  </div>
</main>

<button id="floatingSave" onclick="saveBatchData()">ğŸ’¾</button>

<script>
const API = 'https://script.google.com/macros/s/AKfycby2I6Q2M67npEFW-Vqi14JS3L7rtuQ9DLD35KwhwCaGpyt3xBnRfNyeLcOGXfslA9sx/exec';
const CLOUD_NAME = 'disr3dmsj';
const UPLOAD_PRESET = 'mercariup';
const CLOUD_FOLDER = 'mercari';

let password = '';
let allItems = [];
let allCustomerIds = [];
let currentFilter = 'todo';
let currentArrival = 'æœªåˆ°è²¨';
let pendingUpdates = new Map();

function setFilter(val) {
  currentFilter = val;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('f-' + val).classList.add('active');
  render();
}

function doLogin() {
  const pwInput = document.getElementById('pw');
  password = pwInput.value.trim();
  if(!password) return;
  document.getElementById('loginStatus').textContent = 'é©—è­‰ä¸­...';

  const body = new URLSearchParams();
  body.append('action','getAdminItems');
  body.append('password',password);

  fetch(API, {method:'POST', body})
    .then(r => r.json())
    .then(d => {
      if(d.error) throw new Error(d.error);
      allItems = d.items || [];
      
      // ç²å–å®¢æˆ¶ ID åˆ—è¡¨
      fetch(API, {method:'POST', body: new URLSearchParams({action:'getCustomerIds', password:password})})
        .then(r=>r.json()).then(res => {
          allCustomerIds = res.ids || [];
          const dl = document.getElementById('idList');
          dl.innerHTML = allCustomerIds.map(id => `<option value="${esc(id)}">`).join('');
        });

      document.getElementById('login').style.display = 'none';
      document.getElementById('adminNav').style.display = 'grid';
      document.getElementById('mainPanel').style.display = 'block';
      
      const dateInput = document.getElementById('arrivalDateInput');
      if(dateInput) {
        const today = new Date();
        dateInput.value = today.toISOString().split('T')[0];
      }

      setFilter('todo');
      buildArrivalTabs();
    })
    .catch(err => { document.getElementById('loginStatus').textContent = 'å¯†ç¢¼éŒ¯èª¤'; });
}

function render() {
  const listEl = document.getElementById('list');
  listEl.innerHTML = '';
  
  let items = allItems.filter(i => {
    if(currentFilter === 'todo') return !i.image;
    if(currentFilter === 'done') return !!i.image;
    return true;
  }).filter(i => {
    const arr = String(i.arrival || '').trim();
    return (currentArrival === 'æœªåˆ°è²¨') ? (!arr) : (arr === currentArrival);
  });

  items.forEach(it => {
    const isPending = pendingUpdates.has(it.row);
    const pData = pendingUpdates.get(it.row) || {};
    
    const displayImg = pData.image !== undefined ? pData.image : it.image;
    const displayWeight = pData.weight !== undefined ? pData.weight : (it.weight || '');
    const displayId = pData.custId !== undefined ? pData.custId : (it.custId || '');
    const displayPos = pData.position !== undefined ? pData.position : (it.position || '');

    const card = document.createElement('div');
    card.className = `card-fixed ${isPending ? 'pending-card' : ''}`;
    
    card.innerHTML = `
      <div class="card-left">
        <div class="code-tag">${esc(it.code || 'ç„¡ç·¨è™Ÿ')}</div>
        <div style="font-weight:bold; font-size:15px; color:#1e293b; margin-bottom:4px;">${esc(it.item)}</div>
        
        <div style="font-size:12px; color:#64748b; margin-top:5px;">ID: 
          <input type="text" list="idList" class="id-input" value="${esc(displayId)}" placeholder="è¼¸å…¥æˆ–é¸æ“‡ ID">
        </div>

        <div class="pos-group">
          ${['Wts', 'IG', 'FB', 'Line', 'TW'].map(p => `
            <button class="pos-btn ${displayPos === p ? 'selected' : ''}" 
                    onclick="updateField(${it.row}, 'position', '${p}')">${p}</button>
          `).join('')}
        </div>

        <div style="margin-top:10px;">
          <input type="number" step="0.001" class="weight-input" value="${displayWeight}" placeholder="0.000" inputmode="decimal">
          <span style="font-weight:bold; font-size:12px; color:#64748b;">kg</span>
        </div>
      </div>
      <div class="card-right">
        <div class="card-img-wrap">
          ${displayImg ? `<img src="${escAttr(displayImg)}" class="card-img">` : `<div style="line-height:85px; color:#ccc; font-size:12px;">ç„¡åœ–</div>`}
        </div>
        <div style="display:flex; gap:4px; justify-content:center">
          <button class="photo-btn" onclick="triggerUpload(${it.row}, 'cam')">ğŸ“·</button>
          <button class="photo-btn" onclick="triggerUpload(${it.row}, 'gal')">ğŸ–¼ï¸</button>
        </div>
        <input type="file" id="file-${it.row}" accept="image/*" style="display:none">
        <div id="st-${it.row}" style="font-size:10px; margin-top:4px; color:#64748b;">${isPending ? 'â³ å¾…å„²å­˜' : ''}</div>
      </div>
    `;

    // ç›£è½ ID
    const idInp = card.querySelector('.id-input');
    idInp.oninput = () => updateField(it.row, 'custId', idInp.value);

    // ç›£è½é‡é‡
    const wInp = card.querySelector('.weight-input');
    wInp.oninput = () => updateField(it.row, 'weight', wInp.value);

    listEl.appendChild(card);
  });
}

function updateField(row, field, value) {
  let item = allItems.find(i => i.row === row);
  let data = pendingUpdates.get(row) || { 
    image: item.image || '', 
    weight: item.weight || '', 
    position: item.position || '', 
    custId: item.custId || '' 
  };
  data[field] = value;
  pendingUpdates.set(row, data);
  render();
  updateUIStates();
}

function triggerUpload(row, mode) {
  const inp = document.getElementById('file-' + row);
  if(mode === 'cam') inp.setAttribute('capture', 'environment');
  else inp.removeAttribute('capture');
  
  inp.onchange = async () => {
    if(!inp.files[0]) return;
    const st = document.getElementById('st-' + row);
    st.textContent = 'ä¸Šå‚³ä¸­...';
    try {
      const url = await compressAndUpload(inp.files[0]);
      updateField(row, 'image', url);
    } catch(e) { st.textContent = 'âŒ å¤±æ•—'; }
  };
  inp.click();
}

function updateUIStates() {
  const count = pendingUpdates.size;
  document.getElementById('batchBar').style.display = count > 0 ? 'block' : 'none';
  document.getElementById('floatingSave').style.display = count > 0 ? 'flex' : 'none';
  document.getElementById('pendingMsg').textContent = `ğŸ“ ${count} é …å¾…å„²å­˜`;
}

async function saveBatchData() {
  if (pendingUpdates.size === 0) return;
  if (!confirm("ç¢ºå®šå„²å­˜å…¨éƒ¨ä¿®æ”¹ï¼Ÿ")) return;

  const dateVal = document.getElementById('arrivalDateInput').value;
  const d = new Date(dateVal);
  const formattedDate = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;

  const btn = document.querySelector('#batchBar button:last-child');
  btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­...';

  const tasks = Array.from(pendingUpdates.entries()).map(([row, data]) => {
    const body = new URLSearchParams();
    body.append('action', 'saveArrivalData'); 
    body.append('password', password);
    body.append('row', row);
    body.append('image', data.image || '');
    body.append('weight', data.weight || '');
    body.append('arrivalDate', formattedDate);
    body.append('position', data.position || '');
    body.append('custId', data.custId || '');
    return fetch(API, {method:'POST', body}).then(r => r.json());
  });

  try {
    await Promise.all(tasks);
    alert('æˆåŠŸï¼æ•¸æ“šå·²æ›´æ–°');
    pendingUpdates.clear();
    const refreshBody = new URLSearchParams();
    refreshBody.append('action','getAdminItems');
    refreshBody.append('password',password);
    fetch(API, {method:'POST', body: refreshBody})
      .then(r => r.json()).then(d => {
        allItems = d.items || [];
        render(); updateUIStates();
        btn.disabled = false; btn.textContent = 'ğŸ’¾ å„²å­˜å…¨éƒ¨';
      });
  } catch (err) { alert('å„²å­˜å¤±æ•—'); btn.disabled = false; }
}

function clearPendingUpdates() {
  if (pendingUpdates.size > 0 && confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœªå„²å­˜çš„è®Šå‹•å—ï¼Ÿ")) {
    pendingUpdates.clear();
    render(); updateUIStates();
  }
}

function buildArrivalTabs(){
  const tabs = document.getElementById('arrivalTabs');
  tabs.innerHTML = '';
  let arrivals = [...new Set(allItems.map(i=>i.arrival).filter(a=>a && String(a).trim()))];
  arrivals.sort((a,b)=>groupNum(b)-groupNum(a));
  ['æœªåˆ°è²¨', ...arrivals.slice(0,4)].forEach(name => {
    const t = document.createElement('div');
    t.style.cssText = `padding: 8px 15px; border-radius: 20px; background: ${currentArrival===name?'#2563eb':'#fff'}; color: ${currentArrival===name?'#fff':'#475569'}; border: 1px solid #ddd; cursor: pointer; white-space: nowrap; font-size: 13px; font-weight: bold;`;
    t.textContent = name;
    t.onclick = () => { currentArrival = name; render(); buildArrivalTabs(); };
    tabs.appendChild(t);
  });
}

function groupNum(str){ const m = String(str||'').match(/\d+/); return m ? parseInt(m[0],10) : -1; }
async function compressAndUpload(file) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const max = 1000;
      let w = img.width, h = img.height;
      if (w > h && w > max) { h *= max / w; w = max; }
      else if (h > max) { w *= max / h; h = max; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => {
        const fd = new FormData();
        fd.append('file', blob);
        fd.append('upload_preset', UPLOAD_PRESET);
        fd.append('folder', CLOUD_FOLDER);
        fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: fd })
          .then(r => r.json()).then(res => resolve(res.secure_url)).catch(reject);
      }, 'image/jpeg', 0.7);
    };
    reader.readAsDataURL(file);
  });
}
function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escAttr(s){ return esc(s).replace(/\n/g,' '); }
</script>
</body>
</html>
