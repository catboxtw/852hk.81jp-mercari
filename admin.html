<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
<title>ğŸ‡¯ğŸ‡µç®¡ç†å“¡å¾Œå°</title>
<link rel="stylesheet" href="style.css?v=20251225-4">
<style>
  :root { --primary-color: #2563eb; --bg-light: #f8fafc; --warn-color: #f57c00; }
  
  /* å…¨å±€å„ªåŒ–ï¼šé˜²æ­¢ iOS é»æ“Šé–ƒçˆèˆ‡ç¸®æ”¾ */
  * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
  
  body { 
    background: var(--bg-light); 
    margin: 0; padding: 0; 
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    overflow-x: hidden;
  }

  .admin-wrap { 
    max-width: 1000px; margin: 0 auto; padding: 15px; 
    min-height: 100vh; display: flex; flex-direction: column;
  }
  
  /* ç™»å…¥ä»‹é¢å„ªåŒ– */
  .admin-login { 
    background: #fff; padding: 30px 20px; border-radius: 16px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
    width: 90%; max-width: 350px; margin: 60px auto; 
    text-align: center; position: relative; z-index: 1001;
  }

  /* é—œéµï¼šå¼·åˆ¶ 16px ä»¥ä¸Šé˜²æ­¢ Android/iOS ç¸®æ”¾ */
  .admin-login input, .weight-input { 
    font-size: 16px !important; 
    border: 2px solid #e2e8f0; border-radius: 8px;
    padding: 12px; width: 100%; outline: none;
    -webkit-appearance: none; /* å»é™¤ iOS é è¨­å…§é™°å½± */
  }

  .admin-login button { 
    width: 100%; padding: 15px; margin-top: 10px;
    background: var(--primary-color); color: white; 
    border: none; border-radius: 8px; font-size: 16px; font-weight: bold;
    cursor: pointer; touch-action: manipulation;
  }

  /* å°èˆªæŒ‰éˆ• */
  .admin-nav { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
  .nav-btn { 
    padding: 12px 5px; border-radius: 10px; background: #fff; 
    color: #475569; font-weight: bold; border: 2px solid transparent;
    display: flex; flex-direction: column; align-items: center; gap: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  .nav-btn.active { background: var(--primary-color); color: #fff; }

  /* å¡ç‰‡èˆ‡è¼¸å…¥å„ªåŒ– */
  .weight-input-wrap { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
  .weight-input { width: 100px; font-weight: bold; background: #f1f5f9; }

  #batchBar { display: none; background: #fff4e5; border: 1px solid #ffe0b2; padding: 12px; border-radius: 12px; margin-bottom: 15px; position: sticky; top: 10px; z-index: 99; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  #floatingSave { display: none; position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: var(--warn-color); color: white; border: none; font-size: 28px; z-index: 101; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }

  .tab-content { display: none; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
  .tab-content.active { display: block; }
</style>
</head>

<body>
<main class="admin-wrap">
  <div style="text-align: center; margin-bottom: 20px;"><h1>ç®¡ç†å“¡å¾Œå°</h1></div>

  <div id="login" class="admin-login">
    <h3>èº«åˆ†é©—è­‰</h3>
    <input id="pw" type="password" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" inputmode="text" enterkeyhint="done">
    <button id="loginBtn" type="button">é€²å…¥ç®¡ç†ç³»çµ±</button>
    <div id="loginStatus" style="margin-top:15px; color: #64748b; font-size: 14px;"></div>
  </div>

  <div id="adminNav" class="admin-nav" style="display:none;">
    <button class="nav-btn" onclick="handleNavClick('id-search.html')"><span>ğŸ”</span>æŸ¥è©¢ ID</button>
    <button class="nav-btn active" data-tab="arrivalSection" onclick="switchTab(this)"><span>âš–ï¸</span>åˆ°è²¨ç£…é‡</button>
    <button class="nav-btn" data-tab="pickingSection" onclick="switchTab(this)"><span>ğŸ“¦</span>åŸ·è²¨</button>
    <button class="nav-btn" data-tab="notifySection" onclick="switchTab(this)"><span>ğŸ“¢</span>é€šçŸ¥å®¢äºº</button>
  </div>

  <div id="batchBar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <span id="pendingMsg" style="color: #e65100; font-weight: bold;">ğŸ“ 0 é …æœªå„²å­˜</span>
      <button onclick="saveBatchData()" style="background:#f57c00; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold;">ğŸ’¾ å„²å­˜å…¨éƒ¨</button>
    </div>
  </div>

  <div id="mainPanel" style="display:none">
    <div id="arrivalSection" class="tab-content active">
      <div class="filter">
        <button type="button" data-filter="todo">æœªå®Œæˆ</button>
        <button type="button" data-filter="done">å·²å®Œæˆ</button>
        <button type="button" data-filter="all">å…¨éƒ¨</button>
      </div>
      <div id="arrivalTabs" class="tabs"></div>
      <div id="list"></div>
    </div>
  </div>
</main>

<button id="floatingSave" onclick="saveBatchData()">ğŸ’¾</button>

<script>
const API = 'https://script.google.com/macros/s/AKfycby2I6Q2M67npEFW-Vqi14JS3L7rtuQ9DLD35KwhwCaGpyt3xBnRfNyeLcOGXfslA9sx/exec';
const CLOUD_NAME = 'disr3dmsj';
const UPLOAD_PRESET = 'mercariup';
const CLOUD_FOLDER = 'mercari';

let password = '';
let allItems = [];
let currentFilter = 'todo';
let currentArrival = 'æœªåˆ°è²¨';
let pendingUpdates = new Map();

document.addEventListener('DOMContentLoaded', () => {
  const loginBtn = document.getElementById('loginBtn');
  
  // æ ¸å¿ƒä¿®æ­£ï¼šåŒæ™‚ç›£è½å¤šå€‹äº‹ä»¶ï¼Œè§£æ±º iOS é»æ“Šå¤±æ•ˆ
  const handleLogin = (e) => {
    if (e) e.preventDefault(); 
    doLogin();
  };

  loginBtn.addEventListener('click', handleLogin);
  document.getElementById('pw').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') handleLogin(e);
  });
});

function doLogin() {
  const pwInput = document.getElementById('pw');
  password = pwInput.value.trim();
  if(!password) return;

  const status = document.getElementById('loginStatus');
  status.textContent = 'é©—è­‰ä¸­...';
  
  // éµç›¤æ”¶èµ·ï¼Œé˜²æ­¢ç•«é¢è·³å‹•
  pwInput.blur(); 

  const body = new URLSearchParams();
  body.append('action','getAdminItems');
  body.append('password',password);

  fetch(API,{method:'POST',body})
    .then(r=>r.json())
    .then(d=>{
      if(d.error) throw new Error(d.error);
      allItems = (d.items || []).filter(it => String(it.item||'').trim());
      document.getElementById('login').style.display='none';
      document.getElementById('adminNav').style.display='grid';
      document.getElementById('mainPanel').style.display='block';
      buildArrivalTabs();
      render();
    })
    .catch(err => { 
      status.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥';
      pwInput.value = '';
    });
}

function updateUIStates() {
  const count = pendingUpdates.size;
  document.getElementById('batchBar').style.display = count > 0 ? 'block' : 'none';
  document.getElementById('floatingSave').style.display = count > 0 ? 'flex' : 'none';
  document.getElementById('pendingMsg').textContent = `ğŸ“ ${count} é …å¾…å„²å­˜`;
}

// å„²å­˜è‡³ä¸»è¡¨
async function saveBatchData() {
  if (pendingUpdates.size === 0) return;
  
  // é©—è­‰é‡é‡
  for (let [row, data] of pendingUpdates) {
    if (!data.weight || parseFloat(data.weight) <= 0) {
      alert(`è«‹è¼¸å…¥ç¬¬ ${row} è¡Œçš„é‡é‡`);
      return;
    }
  }

  if(!confirm("ç¢ºå®šä¸Šå‚³ï¼Ÿè³‡æ–™å°‡æ–¼å‡Œæ™¨ 4 é»åŒæ­¥ã€‚")) return;

  const btn = document.querySelector('#batchBar button');
  btn.disabled = true; btn.textContent = 'å„²å­˜ä¸­...';

  const tasks = Array.from(pendingUpdates.entries()).map(([row, data]) => {
    const body = new URLSearchParams();
    body.append('action', 'saveArrivalData'); 
    body.append('password', password);
    body.append('row', row);
    body.append('image', data.image || '');
    body.append('weight', data.weight || '');
    return fetch(API, {method:'POST', body}).then(r=>r.json());
  });

  try {
    await Promise.all(tasks);
    alert('ä¸Šå‚³æˆåŠŸï¼');
    pendingUpdates.clear();
    location.reload();
  } catch (err) {
    alert('å„²å­˜å¤±æ•—');
    btn.disabled = false;
  }
}

function render() {
  const listEl = document.getElementById('list');
  listEl.innerHTML = '';
  let items = allItems.filter(i => {
    if(currentFilter==='todo') return !i.image;
    if(currentFilter==='done') return !!i.image;
    return true;
  }).filter(i => {
    const arr = String(i.arrival || '').trim();
    return (currentArrival==='æœªåˆ°è²¨') ? (!arr) : (arr === currentArrival);
  });

  items.forEach(it => {
    const isPending = pendingUpdates.has(it.row);
    const displayImg = isPending ? pendingUpdates.get(it.row).image : it.image;
    const displayWeight = isPending ? pendingUpdates.get(it.row).weight : (it.weight || '');

    const card = document.createElement('div');
    card.className = `card-fixed ${isPending ? 'pending-card' : ''}`;
    card.innerHTML = `
      <div class="card-left">
        <div style="font-weight:bold">${esc(it.item)}</div>
        <div class="muted" style="font-size:12px">ID: ${esc(it.custId)} | ${esc(it.position)}</div>
        <div class="weight-input-wrap">
          <input type="number" step="0.001" class="weight-input" value="${displayWeight}" placeholder="0.000" inputmode="decimal">
          <span>kg</span>
        </div>
      </div>
      <div class="card-right">
        <div class="card-img-wrap">
          ${displayImg ? `<img src="${escAttr(displayImg)}" class="card-img">` : `<div class="card-img-placeholder">ç„¡åœ–</div>`}
        </div>
        <div class="photo-actions">
          <button class="photo-btn cam">ğŸ“·</button>
          <button class="photo-btn gal">ğŸ–¼ï¸</button>
        </div>
        <input type="file" accept="image/*" style="display:none" class="file-input">
      </div>
    `;

    const weightInp = card.querySelector('.weight-input');
    weightInp.oninput = () => {
      let data = pendingUpdates.get(it.row) || { image: it.image || '' };
      data.weight = weightInp.value;
      pendingUpdates.set(it.row, data);
      card.classList.add('pending-card');
      updateUIStates();
    };

    const fileInp = card.querySelector('.file-input');
    card.querySelector('.cam').onclick = () => { fileInp.setAttribute('capture','environment'); fileInp.click(); };
    card.querySelector('.gal').onclick = () => { fileInp.removeAttribute('capture'); fileInp.click(); };

    fileInp.onchange = async () => {
      const f = fileInp.files[0];
      if(!f) return;
      try {
        const url = await compressAndUpload(f);
        let data = pendingUpdates.get(it.row) || { weight: weightInp.value };
        data.image = url;
        pendingUpdates.set(it.row, data);
        render(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°åœ–ç‰‡
        updateUIStates();
      } catch(e) { alert('ä¸Šå‚³å¤±æ•—'); }
    };
    listEl.appendChild(card);
  });
}

// è¼”åŠ©å‡½æ•¸
function buildArrivalTabs(){
  const tabs = document.getElementById('arrivalTabs');
  tabs.innerHTML = '';
  let arrivals = [...new Set(allItems.map(i=>i.arrival).filter(a=>a && String(a).trim()))];
  arrivals.sort((a,b)=>groupNum(b)-groupNum(a));
  ['æœªåˆ°è²¨', ...arrivals.slice(0,3)].forEach(name => {
    const t = document.createElement('div');
    t.className = `tab ${currentArrival === name ? 'active' : ''}`;
    t.textContent = name;
    t.onclick = () => { currentArrival = name; render(); buildArrivalTabs(); };
    tabs.appendChild(t);
  });
}

function groupNum(str){ const m = String(str||'').match(/\d+/); return m ? parseInt(m[0],10) : -1; }

async function compressAndUpload(file) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const max = 1000;
      let w = img.width, h = img.height;
      if (w > h && w > max) { h *= max / w; w = max; }
      else if (h > max) { w *= max / h; h = max; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => {
        const fd = new FormData();
        fd.append('file', blob);
        fd.append('upload_preset', UPLOAD_PRESET);
        fd.append('folder', CLOUD_FOLDER);
        fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: fd })
          .then(r => r.json()).then(res => resolve(res.secure_url)).catch(reject);
      }, 'image/jpeg', 0.7);
    };
    reader.readAsDataURL(file);
  });
}

function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escAttr(s){ return esc(s).replace(/\n/g,' '); }

function handleNavClick(url) {
  if (pendingUpdates.size > 0 && !confirm("è³‡æ–™æœªå„²å­˜ï¼Œç¢ºå®šé›¢é–‹ï¼Ÿ")) return;
  location.href = url;
}

function switchTab(btn) {
  const targetId = btn.getAttribute('data-tab');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.getElementById(targetId).classList.add('active');
}
</script>
</body>
</html>
