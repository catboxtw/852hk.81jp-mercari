<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
<title>ğŸ‡¯ğŸ‡µMercariä»£è³¼-ç®¡ç†å“¡å¾Œå°</title>
<link rel="stylesheet" href="style.css?v=20251225-3">
<style>
  :root { --primary-color: #2563eb; --bg-light: #f8fafc; --warn-color: #f57c00; }
  
  /* å…¨å±€æ‰‹æ©Ÿå„ªåŒ– */
  body { background: var(--bg-light); margin: 0; padding: 0; font-family: -apple-system, sans-serif; }
  .admin-wrap { 
    max-width: 1000px; 
    margin: 0 auto; 
    padding: 15px; 
    padding-bottom: 100px; 
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  
  /* ç™»å…¥ä»‹é¢å„ªåŒ– - è§£æ±ºæ‰‹æ©Ÿç„¡æ³•è¼¸å…¥å•é¡Œ */
  .admin-login { 
    background: #fff; 
    padding: 30px 20px; 
    border-radius: 16px; 
    box-shadow: 0 10px 25px rgba(0,0,0,0.1); 
    max-width: 350px; 
    margin: 60px auto; 
    text-align: center;
    position: relative;
    z-index: 1000; /* ç¢ºä¿åœ¨æœ€å‰æ–¹ */
  }
  .admin-login h3 { margin-top: 0; color: #1e293b; }
  .admin-login input { 
    width: 100%; 
    padding: 15px; 
    margin: 15px 0; 
    border: 2px solid #e2e8f0; 
    border-radius: 8px; 
    font-size: 16px; /* é˜²æ­¢ iOS ç¸®æ”¾ */
    box-sizing: border-box;
    -webkit-appearance: none;
  }
  .admin-login button { 
    width: 100%; 
    padding: 15px; 
    background: var(--primary-color); 
    color: white; 
    border: none; 
    border-radius: 8px; 
    font-size: 16px; 
    font-weight: bold; 
    cursor: pointer;
  }

  /* å°èˆªæŒ‰éˆ• */
  .admin-nav { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 25px; }
  @media (min-width: 600px) { .admin-nav { grid-template-columns: repeat(4, 1fr); } }

  .nav-btn { 
    padding: 12px 5px; border: none; border-radius: 10px; background: #fff; 
    color: #475569; font-weight: bold; cursor: pointer; 
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; 
    flex-direction: column; align-items: center; gap: 5px; border: 2px solid transparent; 
  }
  .nav-btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
  .nav-btn span { font-size: 20px; }

  /* æš«å­˜æç¤ºæ¢èˆ‡æµ®å‹•æŒ‰éˆ• */
  #batchBar { display: none; background: #fff4e5; border: 1px solid #ffe0b2; padding: 12px 20px; border-radius: 12px; margin-bottom: 15px; position: sticky; top: 10px; z-index: 99; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  #floatingSave { display: none; position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px; border-radius: 50%; background: var(--warn-color); color: white; border: none; font-size: 30px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 101; align-items: center; justify-content: center; }

  /* é‡é‡è¼¸å…¥èˆ‡å¡ç‰‡ */
  .weight-input-wrap { margin-top: 10px; display: flex; align-items: center; gap: 8px; }
  .weight-input { 
    width: 90px; padding: 10px; border: 2px solid #cbd5e1; border-radius: 8px; 
    font-size: 16px; font-weight: bold; inputmode: decimal; 
  }
  .weight-input:focus { border-color: var(--warn-color); outline: none; background: #fffef2; }
  .pending-card { border: 2px solid var(--warn-color) !important; background: #fffaf5 !important; }

  .tab-content { display: none; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
  .tab-content.active { display: block; }
  .muted { color: #64748b; font-size: 13px; }
</style>
</head>

<body>
<main class="admin-wrap">
  <div style="text-align: center; margin-bottom: 20px;"><h1>ç®¡ç†å“¡å¾Œå°</h1></div>

  <div id="login" class="admin-login">
    <h3>èº«åˆ†é©—è­‰</h3>
    <input id="pw" type="password" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" autocomplete="current-password" inputmode="text" enterkeyhint="done">
    <button id="loginBtn" type="button">é€²å…¥ç®¡ç†ç³»çµ±</button>
    <div id="loginStatus" class="muted" style="margin-top:15px; min-height: 20px;"></div>
  </div>

  <div id="adminNav" class="admin-nav" style="display:none;">
    <button class="nav-btn" onclick="handleNavClick('id-search.html')"><span>ğŸ”</span>æŸ¥è©¢ ID</button>
    <button class="nav-btn active" data-tab="arrivalSection" onclick="switchTab(this)"><span>âš–ï¸</span>åˆ°è²¨ç£…é‡</button>
    <button class="nav-btn" data-tab="pickingSection" onclick="switchTab(this)"><span>ğŸ“¦</span>åŸ·è²¨</button>
    <button class="nav-btn" data-tab="notifySection" onclick="switchTab(this)"><span>ğŸ“¢</span>é€šçŸ¥å®¢äºº</button>
  </div>

  <div id="batchBar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <span id="pendingMsg" style="color: #e65100; font-weight: bold; font-size: 14px;">ğŸ“ 0 é …æœªå„²å­˜</span>
      <button onclick="saveBatchData()" style="background:#f57c00; color:white; border:none; padding:10px 18px; border-radius:8px; font-weight:bold; cursor:pointer;">ğŸ’¾ å„²å­˜å…¨éƒ¨</button>
    </div>
  </div>

  <div id="mainPanel" style="display:none">
    <div id="arrivalSection" class="tab-content active">
      <div class="filter">
        <button type="button" data-filter="todo">æœªå®Œæˆ</button>
        <button type="button" data-filter="done">å·²å®Œæˆ</button>
        <button type="button" data-filter="all">å…¨éƒ¨</button>
      </div>
      <div id="arrivalTabs" class="tabs"></div>
      <div id="list"></div>
    </div>
    <div id="pickingSection" class="tab-content"><div class="placeholder-view"><h3>ğŸ“¦ åŸ·è²¨åŠŸèƒ½é–‹ç™¼ä¸­</h3></div></div>
    <div id="notifySection" class="tab-content"><div class="placeholder-view"><h3>ğŸ“¢ é€šçŸ¥åŠŸèƒ½é–‹ç™¼ä¸­</h3></div></div>
  </div>
</main>

<button id="floatingSave" onclick="saveBatchData()">ğŸ’¾</button>

<datalist id="id-list"></datalist>

<script>
const API = 'https://script.google.com/macros/s/AKfycby2I6Q2M67npEFW-Vqi14JS3L7rtuQ9DLD35KwhwCaGpyt3xBnRfNyeLcOGXfslA9sx/exec';
const CLOUD_NAME = 'disr3dmsj';
const UPLOAD_PRESET = 'mercariup';
const CLOUD_FOLDER = 'mercari';

let password = '';
let allItems = [];
let currentFilter = 'todo';
let currentArrival = 'æœªåˆ°è²¨';
let pendingUpdates = new Map();

// --- å°èˆªæ§åˆ¶ ---
function handleNavClick(url) {
  if (pendingUpdates.size > 0) {
    if (!confirm("âš ï¸ æš«å­˜å€é‚„æœ‰è³‡æ–™æœªå„²å­˜ï¼Œé›¢é–‹å°‡æœƒéºå¤±é€²åº¦ï¼ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ")) return;
  }
  location.href = url;
}

function switchTab(btn) {
  if (pendingUpdates.size > 0) {
    if (!confirm("âš ï¸ æš«å­˜å€é‚„æœ‰è³‡æ–™æœªå„²å­˜ï¼Œåˆ‡æ›åˆ†é æœƒæ¸…é™¤é€²åº¦ï¼ç¢ºå®šåˆ‡æ›ï¼Ÿ")) return;
    pendingUpdates.clear();
    updateUIStates();
  }
  const targetId = btn.getAttribute('data-tab');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.getElementById(targetId).classList.add('active');
}

// --- åˆå§‹åŒ–èˆ‡ç™»å…¥ ---
document.addEventListener('DOMContentLoaded', () => {
  const loginBtn = document.getElementById('loginBtn');
  loginBtn.onclick = doLogin;
  document.getElementById('pw').onkeydown = (e) => e.key==='Enter' && doLogin();

  document.querySelectorAll('.filter button').forEach(btn => {
    btn.onclick = () => { currentFilter = btn.dataset.filter; render(); };
  });
});

function doLogin() {
  password = document.getElementById('pw').value.trim();
  if(!password) return;
  const status = document.getElementById('loginStatus');
  status.textContent = 'é©—è­‰ä¸­...';

  const body = new URLSearchParams();
  body.append('action','getAdminItems');
  body.append('password',password);

  fetch(API,{method:'POST',body})
    .then(r=>r.json())
    .then(d=>{
      if(d.error) throw new Error(d.error);
      allItems = (d.items || []).filter(it => String(it.item||'').trim());
      buildArrivalTabs();
      document.getElementById('login').style.display='none';
      document.getElementById('adminNav').style.display='grid';
      document.getElementById('mainPanel').style.display='block';
      render();
    })
    .catch(err => { status.textContent = 'å¯†ç¢¼éŒ¯èª¤æˆ–é€£ç·šå¤±æ•—'; });
}

function updateUIStates() {
  const count = pendingUpdates.size;
  document.getElementById('batchBar').style.display = count > 0 ? 'block' : 'none';
  document.getElementById('floatingSave').style.display = count > 0 ? 'flex' : 'none';
  document.getElementById('pendingMsg').textContent = `ğŸ“ æœ‰ ${count} é …ä¿®æ”¹å°šæœªå„²å­˜`;
}

// --- å„²å­˜é‚è¼¯ (ä¸Šå‚³è‡³ä¸»è¡¨) ---
async function saveBatchData() {
  for (let [row, data] of pendingUpdates) {
    if (!data.weight || parseFloat(data.weight) <= 0) {
      alert(`âš ï¸ ç¬¬ ${row} è¡Œå°šæœªè¼¸å…¥æœ‰æ•ˆé‡é‡ï¼`);
      return;
    }
  }

  if(!confirm("ç¢ºå®šè¦å°‡æ‰€æœ‰æš«å­˜æ•¸æ“šä¸Šå‚³è‡³ä¸»è¡¨å—ï¼Ÿ")) return;

  const barBtn = document.querySelector('#batchBar button');
  barBtn.disabled = true; barBtn.textContent = 'ğŸš€ å„²å­˜ä¸­...';

  const tasks = Array.from(pendingUpdates.entries()).map(([row, data]) => {
    const body = new URLSearchParams();
    body.append('action', 'saveArrivalData'); 
    body.append('password', password);
    body.append('row', row);
    body.append('image', data.image || '');
    body.append('weight', data.weight || '');
    return fetch(API, {method:'POST', body}).then(r=>r.json());
  });

  try {
    await Promise.all(tasks);
    alert('âœ… è³‡æ–™å·²æˆåŠŸä¸Šå‚³è‡³ä¸»è¡¨ï¼\nè«‹æ³¨æ„ï¼šå®¢æˆ¶ç«¯å°‡æ–¼å‡Œæ™¨ 4 é»æ›´æ–°ã€‚');
    pendingUpdates.clear();
    location.reload();
  } catch (err) {
    alert('âŒ å„²å­˜éƒ¨åˆ†å¤±æ•—ï¼Œè«‹é‡è©¦');
    barBtn.disabled = false; barBtn.textContent = 'ğŸ’¾ å„²å­˜å…¨éƒ¨';
  }
}

// --- æ¸²æŸ“æ¸…å–® ---
function render() {
  const listEl = document.getElementById('list');
  listEl.innerHTML = '';
  let items = allItems.filter(i => {
    if(currentFilter==='todo') return !i.image;
    if(currentFilter==='done') return !!i.image;
    return true;
  }).filter(i => {
    const arr = String(i.arrival || '').trim();
    return (currentArrival==='æœªåˆ°è²¨') ? (!arr) : (arr === currentArrival);
  });

  items.forEach(it => {
    const isPending = pendingUpdates.has(it.row);
    const currentData = pendingUpdates.get(it.row) || {};
    const displayImg = currentData.image || it.image;
    const displayWeight = currentData.weight || it.weight || '';

    const card = document.createElement('div');
    card.className = `card-fixed ${isPending ? 'pending-card' : ''}`;
    card.innerHTML = `
      <div class="card-left">
        ${it.code ? `<div class="code">${esc(it.code)}</div>` : ''}
        <div style="font-weight:bold; font-size:15px; margin-bottom:4px;">${esc(it.item||'')}</div>
        <div class="muted">ID: ${esc(it.custId||'â€”')} | Pos: ${esc(it.position||'â€”')}</div>
        <div class="weight-input-wrap">
          <span style="font-size:14px; font-weight:bold;">é‡é‡:</span>
          <input type="number" step="0.001" class="weight-input" value="${displayWeight}" placeholder="0.000">
          <span style="font-weight:bold;">kg</span>
        </div>
      </div>
      <div class="card-right">
        <div class="card-img-wrap">
          ${displayImg ? `<img class="card-img" src="${escAttr(displayImg)}">` : `<div class="card-img-placeholder">æœªæœ‰åœ–ç‰‡</div>`}
        </div>
        <div class="photo-actions">
          <button class="photo-btn cam">ğŸ“· æ‹ç…§</button>
          <button class="photo-btn gal">ğŸ–¼ï¸ ç›¸ç°¿</button>
        </div>
        <div class="status muted" style="font-size:10px; margin-top:4px;">${isPending ? 'â³ å¾…å„²å­˜' : ''}</div>
        <input type="file" accept="image/*" style="display:none" class="file-input">
      </div>
    `;

    const weightInp = card.querySelector('.weight-input');
    weightInp.oninput = () => {
      let data = pendingUpdates.get(it.row) || { image: it.image || '' };
      data.weight = weightInp.value;
      pendingUpdates.set(it.row, data);
      card.classList.add('pending-card');
      updateUIStates();
    };

    const fileInp = card.querySelector('.file-input');
    card.querySelector('.cam').onclick = () => { fileInp.setAttribute('capture','environment'); fileInp.click(); };
    card.querySelector('.gal').onclick = () => { fileInp.removeAttribute('capture'); fileInp.click(); };

    fileInp.onchange = async () => {
      const f = fileInp.files[0];
      if(!f) return;
      const st = card.querySelector('.status');
      st.textContent = 'ä¸Šå‚³ä¸­...';
      try {
        const url = await compressAndUpload(f);
        let data = pendingUpdates.get(it.row) || { weight: weightInp.value };
        data.image = url;
        pendingUpdates.set(it.row, data);
        card.querySelector('.card-img-wrap').innerHTML = `<img class="card-img" src="${url}">`;
        card.classList.add('pending-card');
        st.textContent = 'âœ… å·²é è¦½';
        updateUIStates();
      } catch(e) { st.textContent = 'âŒ å¤±æ•—'; }
    };
    listEl.appendChild(card);
  });
}

// --- å…¶ä»–å·¥å…· ---
function buildArrivalTabs(){
  const tabs = document.getElementById('arrivalTabs');
  tabs.innerHTML = '';
  let arrivals = [...new Set(allItems.map(i=>i.arrival).filter(a=>a && String(a).trim()))];
  arrivals.sort((a,b)=>groupNum(b)-groupNum(a));
  ['æœªåˆ°è²¨', ...arrivals.slice(0,3)].forEach(name => {
    const t = document.createElement('div');
    t.className = `tab ${currentArrival === name ? 'active' : ''}`;
    t.textContent = name;
    t.onclick = () => { currentArrival = name; render(); buildArrivalTabs(); };
    tabs.appendChild(t);
  });
}

function groupNum(str){ const m = String(str||'').match(/\d+/); return m ? parseInt(m[0],10) : -1; }

async function compressAndUpload(file) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const max = 1000;
      let w = img.width, h = img.height;
      if (w > h && w > max) { h *= max / w; w = max; }
      else if (h > max) { w *= max / h; h = max; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => {
        const fd = new FormData();
        fd.append('file', blob);
        fd.append('upload_preset', UPLOAD_PRESET);
        fd.append('folder', CLOUD_FOLDER);
        fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: fd })
          .then(r => r.json()).then(res => resolve(res.secure_url)).catch(reject);
      }, 'image/jpeg', 0.7);
    };
    reader.readAsDataURL(file);
  });
}

function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escAttr(s){ return esc(s).replace(/\n/g,' '); }
</script>
</body>
</html>
