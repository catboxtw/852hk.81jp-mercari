<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
<title>ğŸ‡¯ğŸ‡µç®¡ç†å“¡å¾Œå°</title>
<style>
  :root { --primary-color: #2563eb; --bg-light: #f8fafc; --warn-color: #f57c00; --success-color: #059669; }
  * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
  body { background: var(--bg-light); margin: 0; padding: 0; font-family: -apple-system, sans-serif; overflow-x: hidden; }
  .admin-wrap { max-width: 1000px; margin: 0 auto; padding: 15px; padding-bottom: 100px; }
  .admin-login { background: #fff; padding: 30px 20px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 95%; max-width: 350px; margin: 60px auto; text-align: center; }
  .admin-nav { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
  .nav-btn { padding: 12px 5px; border-radius: 10px; background: #fff; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; gap: 5px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
  .nav-btn.active { background: var(--primary-color); color: #fff; }
  .card-fixed { display: flex; background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 2px solid transparent; }
  .pending-card { border-color: var(--warn-color) !important; background: #fffaf5 !important; }
  
  /* æ¨™ç±¤æ¨£å¼ */
  .code-tag { background: #475569; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 6px; }
  .green-tag { background: var(--success-color); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-top: 5px; margin-right: 5px; cursor: pointer; }
  .add-btn { background: #e2e8f0; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-top: 5px; cursor: pointer; border: 1px dashed #94a3b8; }

  .card-left { flex: 1; padding-right: 10px; display: flex; flex-direction: column; gap: 4px; }
  .card-right { width: 95px; text-align: center; flex-shrink: 0; }
  .pos-group { display: flex; gap: 3px; margin: 2px 0 6px 0; }
  .pos-btn { flex: 1; padding: 6px 0; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 6px; font-size: 10px; cursor: pointer; color: #64748b; font-weight: 600; }
  .pos-btn.selected { background: #fee2e2; border-color: #ef4444; color: #b91c1c; }
  .id-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; background: #fff; }
  .weight-input { flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 15px; }
  #batchBar { display: none; background: #fff4e5; border: 1px solid #ffe0b2; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  #floatingSave { display: none; position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px; border-radius: 50%; background: var(--warn-color); color: white; border: none; font-size: 30px; z-index: 101; box-shadow: 0 4px 15px rgba(0,0,0,0.3); align-items: center; justify-content: center; }
</style>
</head>

<body>
<datalist id="idList"></datalist>
<main class="admin-wrap">
  <div id="login" class="admin-login">
    <h3 style="margin-top:0">èº«åˆ†é©—è­‰</h3>
    <input id="pw" type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:2px solid #ddd;">
    <button onclick="doLogin()" style="width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight:bold;">é€²å…¥ç®¡ç†ç³»çµ±</button>
    <div id="loginStatus" style="margin-top:10px; color: #64748b;"></div>
  </div>

  <div id="adminNav" class="admin-nav" style="display:none;">
    <button class="nav-btn" onclick="location.href='id-search.html'">ğŸ”æŸ¥è©¢ ID</button>
    <button class="nav-btn active">âš–ï¸åˆ°è²¨ç£…é‡</button>
  </div>

  <div id="batchBar" style="position: relative;">
    <button onclick="clearPendingUpdates()" style="position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 18px; cursor: pointer;">âœ•</button>
    <div style="margin-bottom: 10px;">
      <label style="font-size: 12px; color: #e65100; font-weight: bold;">ğŸ“… åˆ°è²¨æ—¥æœŸ:</label>
      <input type="date" id="arrivalDateInput" style="width: 100%; padding: 8px; border: 1px solid #ffcc80; border-radius: 6px;">
    </div>
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <span id="pendingMsg" style="color: #e65100; font-weight: bold;">ğŸ“ 0 é …å¾…å„²å­˜</span>
      <button onclick="saveBatchData()" style="background:#f57c00; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold;">ğŸ’¾ å„²å­˜å…¨éƒ¨</button>
    </div>
  </div>

  <div id="mainPanel" style="display:none">
    <div id="arrivalTabs" style="display:flex; gap:8px; margin-bottom:15px; overflow-x:auto;"></div>
    <div id="list"></div>
  </div>
</main>
<button id="floatingSave" onclick="saveBatchData()">ğŸ’¾</button>

<script>
const API = 'https://script.google.com/macros/s/AKfycby2I6Q2M67npEFW-Vqi14JS3L7rtuQ9DLD35KwhwCaGpyt3xBnRfNyeLcOGXfslA9sx/exec';
const CLOUD_NAME = 'disr3dmsj', UPLOAD_PRESET = 'mercariup', CLOUD_FOLDER = 'mercari';
const POS_MAP = { 'Wts': 'Whatsapp', 'IG': 'IG', 'FB': 'FB', 'Line': 'Line', 'TW': 'Taiwan' };

let password = '', allItems = [], allCustomerIds = [], currentArrival = 'æœªåˆ°è²¨', pendingUpdates = new Map(), editingRows = new Set();

function doLogin() {
  password = document.getElementById('pw').value.trim();
  document.getElementById('loginStatus').textContent = 'é©—è­‰ä¸­...';
  fetch(API, {method:'POST', body: new URLSearchParams({action:'getAdminItems', password})})
    .then(r => r.json()).then(d => {
      if(d.error) throw new Error();
      allItems = d.items || [];
      document.getElementById('login').style.display = 'none';
      document.getElementById('adminNav').style.display = 'grid';
      document.getElementById('mainPanel').style.display = 'block';
      document.getElementById('arrivalDateInput').value = new Date().toISOString().split('T')[0];
      buildArrivalTabs(); render();
    }).catch(() => { document.getElementById('loginStatus').textContent = 'å¯†ç¢¼éŒ¯èª¤'; });
}

function render() {
  const listEl = document.getElementById('list');
  listEl.innerHTML = '';
  let items = allItems.filter(i => {
    const arr = String(i.arrival || '').trim();
    return (currentArrival === 'æœªåˆ°è²¨') ? (!arr) : (arr === currentArrival);
  });

  items.forEach(it => {
    const isPending = pendingUpdates.has(it.row);
    const pData = pendingUpdates.get(it.row) || {};
    const dW = pData.weight !== undefined ? pData.weight : (it.weight || '');
    const dLink = pData.link !== undefined ? pData.link : (it.link || '');
    const dTrack = pData.track !== undefined ? pData.track : (it.track || '');

    const card = document.createElement('div');
    card.className = `card-fixed ${isPending ? 'pending-card' : ''}`;
    card.innerHTML = `
      <div class="card-left">
        <div class="code-tag">${esc(it.code || 'ç„¡ç·¨è™Ÿ')}</div>
        <div style="font-weight:bold; font-size:14px; color:#1e293b;">${esc(it.item)}</div>
        <div class="pos-group">
          ${Object.keys(POS_MAP).map(k => `<button class="pos-btn ${(pData.position||it.position) === POS_MAP[k] ? 'selected' : ''}" onclick="updateField(${it.row}, 'position', '${POS_MAP[k]}')">${k}</button>`).join('')}
        </div>
        <input type="text" class="id-input" value="${esc(pData.custId || it.custId)}" placeholder="ID" oninput="updateField(${it.row}, 'custId', this.value, true)">
        <div style="display:flex; align-items:center; gap:6px; margin-top:5px;">
          <input type="number" step="0.001" class="weight-input" value="${dW}" placeholder="0.000" oninput="updateField(${it.row}, 'weight', this.value, true)">
          <span style="font-weight:bold; color:#64748b;">kg</span>
        </div>
        <div>
          ${dTrack ? `<span class="green-tag" onclick="editPrompt(${it.row},'track','${esc(dTrack)}')">${esc(dTrack)}</span>` : `<span class="add-btn" onclick="editPrompt(${it.row},'track','')">+ é‹å–®</span>`}
          ${dLink ? `<span class="green-tag" onclick="editPrompt(${it.row},'link','${esc(dLink)}')">å•†å“ç¶²å€</span>` : `<span class="add-btn" onclick="editPrompt(${it.row},'link','')">+ ç¶²å€</span>`}
        </div>
      </div>
      <div class="card-right">
        <div style="width:90px; height:90px; background:#f1f5f9; border-radius:8px; overflow:hidden; margin-bottom:8px;">
          ${(pData.image||it.image) ? `<img src="${pData.image||it.image}" style="width:100%; height:100%; object-fit:cover;">` : `<div style="line-height:90px; color:#ccc; font-size:12px;">ç„¡åœ–</div>`}
        </div>
        <button onclick="triggerUpload(${it.row})" style="padding:10px; width:100%; border-radius:8px; border:1px solid #ddd; background:#fff;">ğŸ“·</button>
      </div>
    `;
    listEl.appendChild(card);
  });
}

function editPrompt(row, field, oldVal) {
  const newVal = prompt(`è¼¸å…¥${field === 'track' ? 'é‹å–®ç·¨è™Ÿ' : 'å•†å“ç¶²å€'}:`, oldVal);
  if (newVal !== null) updateField(row, field, newVal);
}

function updateField(row, field, value, isTyping = false) {
  let data = pendingUpdates.get(row) || {};
  data[field] = value;
  pendingUpdates.set(row, data);
  if(!isTyping) render(); 
  updateUIStates();
}

async function saveBatchData() {
  if (pendingUpdates.size === 0) return;
  const dateVal = document.getElementById('arrivalDateInput').value;
  const formattedDate = dateVal.replace(/-/g, '/');
  
  const tasks = Array.from(pendingUpdates.entries()).map(([row, data]) => {
    const body = new URLSearchParams({ action:'saveArrivalData', password, row });
    if(data.position) body.append('position', data.position);
    if(data.custId) body.append('custId', data.custId);
    if(data.image) body.append('image', data.image);
    if(data.link !== undefined) body.append('link', data.link);
    if(data.track !== undefined) body.append('track', data.track);
    if(data.weight) { body.append('weight', data.weight); body.append('arrivalDate', formattedDate); }
    else body.append('arrivalDate', '');
    return fetch(API, {method:'POST', body}).then(r => r.json());
  });

  await Promise.all(tasks);
  alert('æˆåŠŸ'); location.reload();
}

function buildArrivalTabs(){
  const tabs = document.getElementById('arrivalTabs'); tabs.innerHTML = '';
  ['æœªåˆ°è²¨', ...new Set(allItems.map(i=>i.arrival).filter(Boolean))].forEach(name => {
    const t = document.createElement('div');
    t.style.cssText = `padding:8px 15px; border-radius:20px; background:${currentArrival===name?'#2563eb':'#fff'}; color:${currentArrival===name?'#fff':'#475569'}; cursor:pointer; border:1px solid #ddd; font-weight:bold; white-space:nowrap;`;
    t.textContent = name;
    t.onclick = () => { currentArrival = name; render(); buildArrivalTabs(); };
    tabs.appendChild(t);
  });
}

function triggerUpload(row) {
  const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'image/*'; inp.capture = 'environment';
  inp.onchange = async () => {
    if(!inp.files[0]) return;
    const url = await compressAndUpload(inp.files[0]);
    updateField(row, 'image', url);
  };
  inp.click();
}

async function compressAndUpload(file) {
  return new Promise((resolve) => {
    const img = new Image(); const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas'); const max = 1000;
      let w = img.width, h = img.height;
      if (w > h && w > max) { h *= max/w; w = max; } else if (h > max) { w *= max/h; h = max; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => {
        const fd = new FormData(); fd.append('file', blob); fd.append('upload_preset', UPLOAD_PRESET);
        fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method:'POST', body:fd })
          .then(r => r.json()).then(res => resolve(res.secure_url));
      }, 'image/jpeg', 0.7);
    };
    reader.readAsDataURL(file);
  });
}

function updateUIStates() {
  document.getElementById('batchBar').style.display = pendingUpdates.size > 0 ? 'block' : 'none';
  document.getElementById('floatingSave').style.display = pendingUpdates.size > 0 ? 'flex' : 'none';
  document.getElementById('pendingMsg').textContent = `ğŸ“ ${pendingUpdates.size} é …å¾…å„²å­˜`;
}
function clearPendingUpdates() { pendingUpdates.clear(); render(); updateUIStates(); }
function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
