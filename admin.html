<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
<title>ğŸ‡¯ğŸ‡µç®¡ç†å“¡å¾Œå°</title>
<style>
  :root { --primary-color: #2563eb; --bg-light: #f8fafc; --warn-color: #f57c00; --success-color: #059669; }
  * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
  body { background: var(--bg-light); margin: 0; padding: 0; font-family: -apple-system, sans-serif; overflow-x: hidden; }
  .admin-wrap { max-width: 1000px; margin: 0 auto; padding: 15px; padding-bottom: 120px; }
  .admin-login { background: #fff; padding: 30px 20px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 95%; max-width: 350px; margin: 60px auto; text-align: center; }
  .admin-nav { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
  .nav-btn { padding: 12px 5px; border-radius: 10px; background: #fff; border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; gap: 5px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; }
  .nav-btn.active { background: var(--primary-color); color: #fff; }
  .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; }
  .filter-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; background: #fff; cursor: pointer; font-weight: bold; color: #475569; }
  .filter-btn.active { background: #e2e8f0; border-color: #94a3b8; color: #1e293b; }
  .card-fixed { display: flex; background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 2px solid transparent; }
  .pending-card { border-color: var(--warn-color) !important; background: #fffaf5 !important; }
  .code-tag { background: #475569; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 6px; }
  .card-left { flex: 1; padding-right: 10px; display: flex; flex-direction: column; gap: 4px; }
  .card-right { width: 95px; text-align: center; flex-shrink: 0; }
  .pos-label { font-size: 11px; color: #94a3b8; font-weight: bold; margin-top: 4px; }
  .pos-group { display: flex; gap: 3px; margin: 2px 0 6px 0; }
  .pos-btn { flex: 1; padding: 6px 0; border: 1px solid #e2e8f0; background: #f8fafc; border-radius: 6px; font-size: 10px; cursor: pointer; color: #64748b; font-weight: 600; }
  .pos-btn.selected { background: #fee2e2; border-color: #ef4444; color: #b91c1c; box-shadow: inset 0 0 4px rgba(239, 68, 68, 0.1); }
  .id-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; background: #fff; }
  .weight-row { display: flex; align-items: center; gap: 6px; margin-top: 5px; }
  .weight-input { flex: 1; padding: 8px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 15px; }
  .weight-unit { font-weight: bold; color: #64748b; font-size: 13px; }
  .card-img-wrap { width: 90px; height: 90px; background: #f1f5f9; border-radius: 8px; overflow: hidden; margin-bottom: 8px; border: 1px solid #eee; position: relative; }
  .card-img { width: 100%; height: 100%; object-fit: cover; }
  .preview-label { position: absolute; bottom: 0; width: 100%; background: rgba(37, 99, 235, 0.8); color: white; font-size: 9px; padding: 2px 0; }
  .photo-btn { padding: 10px; border-radius: 8px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
  .url-text { font-size: 10px; color: #3b82f6; word-break: break-all; margin-bottom: 2px; text-decoration: underline; display: block; }
  .green-tag { background: var(--success-color); color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; display: inline-block; margin-top: 5px; cursor: pointer; }
  
  /* å½ˆå‡ºè¦–çª— */
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; }
  .modal-content { background:#fff; width:90%; max-width:400px; padding:20px; border-radius:16px; display:flex; flex-direction:column; gap:10px; }
  .modal-input { padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; width:100%; }

  #batchBar { display: none; background: #fff4e5; border: 1px solid #ffe0b2; padding: 15px; border-radius: 12px; margin-bottom: 15px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
  #floatingSave { display: none; position: fixed; bottom: 25px; right: 25px; width: 65px; height: 65px; border-radius: 50%; background: var(--warn-color); color: white; border: none; font-size: 30px; z-index: 101; box-shadow: 0 4px 15px rgba(0,0,0,0.3); align-items: center; justify-content: center; }
</style>
</head>

<body>
<datalist id="idList"></datalist>

<div id="addModal" class="modal">
  <div class="modal-content">
    <h3 style="margin:0">â• åŠ å…¥æ–°å•†å“</h3>
    <input type="date" id="addDate" class="modal-input">
    <select id="addShop" class="modal-input">
      <option value="Mercari">Mercari</option>
      <option value="Amazon">Amazon</option>
      <option value="Rakuten">Rakuten</option>
      <option value="Yahoo">Yahoo</option>
    </select>
    <input type="text" id="addLink" placeholder="å•†å“ç¶²å€" class="modal-input">
    <input type="text" id="addItem" placeholder="å•†å“åç¨±" class="modal-input">
    <input type="number" id="addJpy" placeholder="åƒ¹éŒ¢ (JPY)" class="modal-input">
    <input type="text" id="addPos" placeholder="Position (å¦‚: Wts)" class="modal-input">
    <input type="text" id="addCustId" placeholder="Customer ID" list="idList" class="modal-input">
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="closeAddModal()" style="flex:1; padding:12px; background:#f1f5f9; border:none; border-radius:8px;">å–æ¶ˆ</button>
      <button onclick="submitNewItem()" style="flex:1; padding:12px; background:var(--primary-color); color:#fff; border:none; border-radius:8px; font-weight:bold;">ç¢ºå®šåŠ å…¥</button>
    </div>
  </div>
</div>

<main class="admin-wrap">
  <div id="login" class="admin-login">
    <h3 style="margin-top:0">èº«åˆ†é©—è­‰</h3>
    <input id="pw" type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:2px solid #ddd;">
    <button onclick="doLogin()" style="width: 100%; padding: 15px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-weight:bold;">é€²å…¥ç®¡ç†ç³»çµ±</button>
    <div id="loginStatus" style="margin-top:10px; color: #64748b;"></div>
  </div>

  <div id="mainPanel" style="display:none">
    <div id="adminNav" class="admin-nav">
      <button class="nav-btn" onclick="location.href='id-search.html'"><span>ğŸ”</span>æŸ¥è©¢ ID</button>
      <button class="nav-btn active"><span>âš–ï¸</span>åˆ°è²¨ç£…é‡</button>
    </div>

    <div id="batchBar">
      <div style="margin-bottom:10px;">
        <label style="font-size:12px; color:#e65100; font-weight:bold;">ğŸ“… åˆ°è²¨æ—¥æœŸ:</label>
        <input type="date" id="arrivalDateInput" style="width:100%; padding:8px; border-radius:6px; border:1px solid #ffcc80;">
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span id="pendingMsg" style="color:#e65100; font-weight:bold;">ğŸ“ 0 é …å¾…å„²å­˜</span>
        <button onclick="saveBatchData()" style="background:#f57c00; color:white; border:none; padding:10px 15px; border-radius:8px; font-weight:bold;">ğŸ’¾ å„²å­˜å…¨éƒ¨</button>
      </div>
    </div>

    <div class="filter-bar">
      <button class="filter-btn" id="f-todo" onclick="setFilter('todo')">æœªå®Œæˆ</button>
      <button class="filter-btn" id="f-done" onclick="setFilter('done')">å·²å®Œæˆ</button>
      <button class="filter-btn" id="f-all" onclick="setFilter('all')">å…¨éƒ¨</button>
    </div>

    <div id="arrivalTabs" style="display:flex; gap:8px; margin-bottom:15px; overflow-x:auto; padding-bottom:5px;"></div>
    <div id="list"></div>

    <div id="addBtnArea" style="margin-top:20px;">
      <button onclick="openAddModal()" style="width:100%; padding:15px; background:#fff; border:2px dashed #cbd5e1; border-radius:12px; color:#64748b; font-weight:bold;">â• åŠ å…¥æ–°å•†å“åˆ°ä¸»è¡¨</button>
    </div>
  </div>
</main>
<button id="floatingSave" onclick="saveBatchData()">ğŸ’¾</button>

<script>
const API = 'https://script.google.com/macros/s/AKfycby2I6Q2M67npEFW-Vqi14JS3L7rtuQ9DLD35KwhwCaGpyt3xBnRfNyeLcOGXfslA9sx/exec'; 
const LINK_PREVIEW_KEY = '03b25d4673fab76cc420aba868dff16b';
const CLOUD_NAME = 'disr3dmsj', UPLOAD_PRESET = 'mercariup', POS_MAP = {'Wts':'Whatsapp', 'IG':'IG', 'FB':'FB', 'Line':'Line', 'TW':'Taiwan'};

let password='', allItems=[], allCustomerIds=[], currentFilter='todo', currentArrival='æœªåˆ°è²¨', pendingUpdates=new Map(), editingRows=new Set(), urlPreviewCache=new Map();

function doLogin() {
  password = document.getElementById('pw').value.trim();
  fetch(API, {method:'POST', body:new URLSearchParams({action:'getAdminItems', password})})
  .then(r=>r.json()).then(d=>{
    if(d.error) throw new Error();
    allItems=d.items||[];
    document.getElementById('login').style.display='none';
    document.getElementById('mainPanel').style.display='block';
    document.getElementById('arrivalDateInput').value = new Date().toISOString().split('T')[0];
    setFilter('todo'); buildArrivalTabs();
    fetch(API, {method:'POST', body:new URLSearchParams({action:'getCustomerIds', password})}).then(r=>r.json()).then(res=>{
      allCustomerIds=res.ids||[];
      document.getElementById('idList').innerHTML = allCustomerIds.map(id=>`<option value="${esc(id)}">`).join('');
    });
  }).catch(()=>alert('å¯†ç¢¼éŒ¯èª¤'));
}

function setFilter(val) { currentFilter=val; render(); }

async function render() {
  const listEl=document.getElementById('list'); listEl.innerHTML='';
  let items = allItems.filter(i=> (currentFilter==='todo'?!i.image : (currentFilter==='done'?!!i.image : true)))
                     .filter(i=> (currentArrival==='æœªåˆ°è²¨'?!i.arrival : i.arrival===currentArrival));

  items.forEach(it=>{
    const pData=pendingUpdates.get(it.row)||{};
    const displayImg=pData.image||it.image, displayWeight=pData.weight!==undefined?pData.weight:it.weight;
    const displayId=pData.custId!==undefined?pData.custId:it.custId, displayPos=pData.position!==undefined?pData.position:it.position;
    const shouldLock = (it.position || it.custId) && !editingRows.has(it.row) && !pendingUpdates.has(it.row);

    const card=document.createElement('div'); card.className=`card-fixed ${pendingUpdates.has(it.row)?'pending-card':''}`;
    
    let posHtml = shouldLock ? 
      `<div style="display:flex; align-items:center; gap:10px; margin-top:5px; background:#f1f5f9; padding:8px; border-radius:8px;">
        <div style="font-size:13px; font-weight:bold;">ğŸ“ ${esc(displayPos)}</div>
        <div style="font-size:13px; color:#94a3b8; flex:1;">ID: ${esc(displayId)}</div>
        <button onclick="editingRows.add(${it.row}); render();" style="padding:4px 8px; font-size:11px; background:#fff; border:1px solid #cbd5e1; border-radius:4px;">âœï¸</button>
      </div>` :
      `<div class="pos-label">Position:</div>
       <div class="pos-group">${Object.keys(POS_MAP).map(k=>`<button class="pos-btn ${displayPos===POS_MAP[k]?'selected':''}" onclick="updateField(${it.row},'position','${POS_MAP[k]}')">${k}</button>`).join('')}</div>
       <input type="text" list="idList" class="id-input" value="${esc(displayId)}" placeholder="Customer ID" oninput="updateField(${it.row},'custId',this.value,true)">`;

    card.innerHTML=`
      <div class="card-left">
        <div class="code-tag">${esc(it.code||'ç„¡ç·¨è™Ÿ')}</div>
        <a class="url-text" href="${it.link}" target="_blank">${it.link?esc(it.link):'(ç„¡ç¶²å€)'}</a>
        <div style="font-weight:bold; font-size:14px;">${esc(it.item)}</div>
        ${posHtml}
        <div class="weight-row">
          <input type="number" step="0.001" class="weight-input" value="${displayWeight||''}" oninput="updateField(${it.row},'weight',this.value,true)">
          <span class="weight-unit">kg</span>
        </div>
        <div>${it.track ? `<span class="green-tag" onclick="editPrompt(${it.row},'track','${esc(it.track)}')">${esc(it.track)}</span>` : `<span style="font-size:11px;color:#94a3b8;cursor:pointer" onclick="editPrompt(${it.row},'track','')">+ é‹å–®</span>`}</div>
      </div>
      <div class="card-right">
        <div class="card-img-wrap" id="img-wrap-${it.row}">
          ${displayImg?`<img src="${displayImg}" class="card-img">`:(it.link?`<div id="load-${it.row}" style="font-size:10px;line-height:90px;">æŠ“å–ä¸­...</div>`:`<div style="line-height:90px;color:#ccc;">ç„¡åœ–</div>`)}
        </div>
        <div style="display:flex; gap:4px; justify-content:center">
          <button class="photo-btn" onclick="triggerUpload(${it.row},'cam')">ğŸ“·</button>
          <button class="photo-btn" onclick="triggerUpload(${it.row},'gal')">ğŸ–¼ï¸</button>
        </div>
      </div>`;
    listEl.appendChild(card);
    if(!displayImg && it.link) fetchPreview(it.link, it.row);
  });
}

function updateField(row,f,v,typing){
  let d=pendingUpdates.get(row)||{}; d[f]=v; pendingUpdates.set(row,d);
  if(!typing) render(); updateUI();
}

function editPrompt(row,f,old){
  const v=prompt(`ä¿®æ”¹ ${f}:`, old);
  if(v!==null) updateField(row,f,v);
}

async function saveBatchData(){
  if(!confirm("å„²å­˜æ‰€æœ‰ä¿®æ”¹ï¼Ÿ")) return;
  const dateVal=document.getElementById('arrivalDateInput').value.replace(/-/g,'/');
  for(let [row,data] of pendingUpdates){
    const p=new URLSearchParams({action:'saveArrivalData', password, row, ...data});
    if(data.weight) p.append('arrivalDate', dateVal);
    await fetch(API,{method:'POST', body:p});
  }
  alert('å„²å­˜æˆåŠŸ'); pendingUpdates.clear(); editingRows.clear(); doLogin();
}

function openAddModal(){ document.getElementById('addModal').style.display='flex'; document.getElementById('addDate').value=new Date().toISOString().split('T')[0]; }
function closeAddModal(){ document.getElementById('addModal').style.display='none'; }
async function submitNewItem(){
  const p={
    action:'addNewItem', password,
    date: document.getElementById('addDate').value.replace(/-/g,'/'),
    shop: document.getElementById('addShop').value,
    link: document.getElementById('addLink').value.trim(),
    item: document.getElementById('addItem').value.trim(),
    jpy: document.getElementById('addJpy').value,
    pos: document.getElementById('addPos').value.trim(),
    id: document.getElementById('addCustId').value.trim()
  };
  await fetch(API,{method:'POST', body:new URLSearchParams(p)});
  alert('å·²åŠ å…¥ä¸»è¡¨'); closeAddModal(); doLogin();
}

function buildArrivalTabs(){
  const tabs=document.getElementById('arrivalTabs'); tabs.innerHTML='';
  let arrs=['æœªåˆ°è²¨', ...new Set(allItems.map(i=>i.arrival).filter(Boolean))].sort();
  arrs.forEach(n=>{
    const t=document.createElement('div'); t.textContent=n;
    t.style.cssText=`padding:8px 15px; border-radius:20px; background:${currentArrival===n?'#2563eb':'#fff'}; color:${currentArrival===n?'#fff':'#475569'}; border:1px solid #ddd; font-size:13px; font-weight:bold; white-space:nowrap; cursor:pointer;`;
    t.onclick=()=>{currentArrival=n; render(); buildArrivalTabs();};
    tabs.appendChild(t);
  });
}

function triggerUpload(row, mode){
  const inp=document.createElement('input'); inp.type='file'; inp.accept='image/*';
  if(mode==='cam') inp.capture='environment';
  inp.onchange=async()=>{
    const file=inp.files[0]; if(!file) return;
    const url=await compressAndUpload(file);
    updateField(row, 'image', url);
  };
  inp.click();
}

async function compressAndUpload(file) {
  return new Promise((resolve) => {
    const img=new Image(); const reader=new FileReader();
    reader.onload=e=>img.src=e.target.result;
    img.onload=()=>{
      const canvas=document.createElement('canvas'); const max=1000;
      let w=img.width, h=img.height;
      if(w>h && w>max){h*=max/w; w=max;} else if(h>max){w*=max/h; h=max;}
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      canvas.toBlob(blob=>{
        const fd=new FormData(); fd.append('file',blob); fd.append('upload_preset',UPLOAD_PRESET);
        fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`,{method:'POST', body:fd}).then(r=>r.json()).then(res=>resolve(res.secure_url));
      },'image/jpeg',0.7);
    };
    reader.readAsDataURL(file);
  });
}

async function fetchPreview(url, row) {
  const mId=url.match(/item\/(m\d+)/);
  let img='';
  if(mId) img=`https://static.mercdn.net/item/detail/orig/photos/${mId[1]}_1.jpg`;
  else {
    const res=await fetch(`https://api.linkpreview.net/?key=${LINK_PREVIEW_KEY}&q=${encodeURIComponent(url)}`);
    const data=await res.json(); img=data.image;
  }
  if(img){
    urlPreviewCache.set(url, img);
    const el=document.getElementById(`img-wrap-${row}`);
    if(el) el.innerHTML=`<img src="${img}" class="card-img"><div class="preview-label">é è¦½</div>`;
  }
}

function updateUI(){
  const s=pendingUpdates.size;
  document.getElementById('batchBar').style.display=s?'block':'none';
  document.getElementById('floatingSave').style.display=s?'flex':'none';
  document.getElementById('pendingMsg').textContent=`ğŸ“ ${s} é …å¾…å„²å­˜`;
}
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }
</script>
</body>
</html>
