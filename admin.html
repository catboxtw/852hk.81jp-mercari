<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ğŸ‡¯ğŸ‡µMercariä»£è³¼-ç®¡ç†å“¡å¾Œå°</title>
<link rel="stylesheet" href="style.css?v=20251225-3">
<style>
  :root { --primary-color: #2563eb; --bg-light: #f8fafc; --warn-color: #f57c00; }
  .admin-wrap { max-width: 1000px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
  
  /* å°èˆªæŒ‰éˆ• */
  .admin-nav { display: none; display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 25px; }
  @media (min-width: 600px) { .admin-nav { grid-template-columns: repeat(4, 1fr); } }

  .nav-btn { padding: 15px 10px; border: none; border-radius: 8px; background: #fff; color: #475569; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 5px; border: 2px solid transparent; }
  .nav-btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
  .nav-btn:hover:not(.active) { border-color: #cbd5e1; }
  .nav-btn span { font-size: 20px; }

  /* æš«å­˜æç¤ºæ¢ */
  #batchBar { display: none; background: #fff4e5; border: 1px solid #ffe0b2; padding: 12px 20px; border-radius: 12px; margin-bottom: 15px; position: sticky; top: 10px; z-index: 99; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

  /* æµ®å‹•å„²å­˜æŒ‰éˆ• */
  #floatingSave { display: none; position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; background: var(--warn-color); color: white; border: none; font-size: 28px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 101; align-items: center; justify-content: center; transition: transform 0.2s; }
  #floatingSave:active { transform: scale(0.9); }

  /* å¡ç‰‡è¼¸å…¥æ¡†ç¾åŒ– */
  .weight-input-wrap { margin-top: 10px; display: flex; align-items: center; gap: 5px; }
  .weight-input { width: 100px; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; font-weight: bold; }
  .weight-input:focus { border-color: var(--warn-color); outline: none; }
  .pending-card { border: 2px solid var(--warn-color) !important; background: #fffaf5 !important; }

  .tab-content { display: none; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
  .tab-content.active { display: block; }
  .admin-login { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); max-width: 400px; margin: 50px auto; text-align: center; }
  .admin-login input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px; }
</style>
</head>

<body>
<main class="admin-wrap">
  <div style="text-align: center; margin-bottom: 20px;"><h1>ç®¡ç†å“¡å¾Œå°</h1></div>

  <div id="login" class="admin-login">
    <h3>èº«åˆ†é©—è­‰</h3>
    <input id="pw" type="password" placeholder="è«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼" autocomplete="current-password">
    <button id="loginBtn" type="button" style="width: 100%;">é€²å…¥ç®¡ç†ç³»çµ±</button>
    <div id="loginStatus" class="muted" style="margin-top:10px;"></div>
  </div>

  <div id="adminNav" class="admin-nav" style="display:none;">
    <button class="nav-btn" onclick="handleNavClick('id-search.html')"><span>ğŸ”</span>æŸ¥è©¢ ID</button>
    <button class="nav-btn active" data-tab="arrivalSection" onclick="switchTab(this)"><span>âš–ï¸</span>åˆ°è²¨ç£…é‡</button>
    <button class="nav-btn" data-tab="pickingSection" onclick="switchTab(this)"><span>ğŸ“¦</span>åŸ·è²¨</button>
    <button class="nav-btn" data-tab="notifySection" onclick="switchTab(this)"><span>ğŸ“¢</span>é€šçŸ¥å®¢äºº</button>
  </div>

  <div id="batchBar">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <span id="pendingMsg" style="color: #e65100; font-weight: bold;">ğŸ“ æœ‰ 0 é …ä¿®æ”¹å°šæœªå„²å­˜</span>
      <button onclick="saveBatchData()" style="background:#f57c00; color:white; border:none; padding:8px 15px; border-radius:6px; font-weight:bold; cursor:pointer;">ğŸ’¾ å„²å­˜å…¨éƒ¨</button>
    </div>
  </div>

  <div id="mainPanel" style="display:none">
    <div id="arrivalSection" class="tab-content active">
      <div class="filter">
        <button type="button" data-filter="todo">æœªå®Œæˆ</button>
        <button type="button" data-filter="done">å·²å®Œæˆ</button>
        <button type="button" data-filter="all">å…¨éƒ¨</button>
      </div>
      <div id="arrivalTabs" class="tabs"></div>
      <div id="list"></div>
    </div>
    <div id="pickingSection" class="tab-content"><div class="placeholder-view"><h3>ğŸ“¦ åŸ·è²¨åŠŸèƒ½é–‹ç™¼ä¸­</h3></div></div>
    <div id="notifySection" class="tab-content"><div class="placeholder-view"><h3>ğŸ“¢ é€šçŸ¥åŠŸèƒ½é–‹ç™¼ä¸­</h3></div></div>
  </div>
</main>

<button id="floatingSave" onclick="saveBatchData()">ğŸ’¾</button>

<datalist id="id-list"></datalist>
<datalist id="pos-list"></datalist>

<script>
const API = 'https://script.google.com/macros/s/AKfycby2I6Q2M67npEFW-Vqi14JS3L7rtuQ9DLD35KwhwCaGpyt3xBnRfNyeLcOGXfslA9sx/exec';
const CLOUD_NAME = 'disr3dmsj';
const UPLOAD_PRESET = 'mercariup';
const CLOUD_FOLDER = 'mercari';

let password = '';
let allItems = [];
let currentFilter = 'todo';
let currentArrival = 'æœªåˆ°è²¨';
let pendingUpdates = new Map(); // Key: row, Value: { image, weight }

// --- å°èˆªèˆ‡å®‰å…¨æª¢æŸ¥ ---
function handleNavClick(url) {
  if (pendingUpdates.size > 0) {
    if (!confirm("âš ï¸ æš«å­˜å€é‚„æœ‰è³‡æ–™æœªå„²å­˜ï¼Œé›¢é–‹å°‡æœƒéºå¤±é€²åº¦ï¼ç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ")) return;
  }
  location.href = url;
}

function switchTab(btn) {
  if (pendingUpdates.size > 0) {
    if (!confirm("âš ï¸ æš«å­˜å€é‚„æœ‰è³‡æ–™æœªå„²å­˜ï¼Œåˆ‡æ›åˆ†é æœƒæ¸…é™¤é€²åº¦ï¼ç¢ºå®šåˆ‡æ›ï¼Ÿ")) return;
    pendingUpdates.clear();
    updateUIStates();
  }
  const targetId = btn.getAttribute('data-tab');
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.getElementById(targetId).classList.add('active');
}

window.onbeforeunload = () => (pendingUpdates.size > 0) ? "è³‡æ–™æœªå„²å­˜ï¼Œç¢ºå®šé›¢é–‹ï¼Ÿ" : null;

// --- æ ¸å¿ƒåŠŸèƒ½ ---
document.addEventListener('DOMContentLoaded', () => {
  const loginBtn = document.getElementById('loginBtn');
  loginBtn.onclick = doLogin;
  document.getElementById('pw').onkeydown = (e) => e.key==='Enter' && doLogin();

  document.querySelectorAll('.filter button').forEach(btn => {
    btn.onclick = () => { currentFilter = btn.dataset.filter; render(); };
  });
});

function doLogin() {
  password = document.getElementById('pw').value.trim();
  if(!password) return;
  document.getElementById('loginStatus').textContent = 'é©—è­‰ä¸­...';

  const body = new URLSearchParams();
  body.append('action','getAdminItems');
  body.append('password',password);

  fetch(API,{method:'POST',body})
    .then(r=>r.json())
    .then(d=>{
      if(d.error) throw new Error(d.error);
      localStorage.setItem('adminPw', password);
      allItems = (d.items || []).filter(it => String(it.item||'').trim());
      buildDatalists();
      buildArrivalTabs();
      document.getElementById('login').style.display='none';
      document.getElementById('adminNav').style.display='grid';
      document.getElementById('mainPanel').style.display='block';
      render();
    })
    .catch(err => { document.getElementById('loginStatus').textContent = 'å¯†ç¢¼éŒ¯èª¤'; });
}

function updateUIStates() {
  const count = pendingUpdates.size;
  const bar = document.getElementById('batchBar');
  const fab = document.getElementById('floatingSave');
  bar.style.display = count > 0 ? 'block' : 'none';
  fab.style.display = count > 0 ? 'flex' : 'none';
  document.getElementById('pendingMsg').textContent = `ğŸ“ æœ‰ ${count} é …ä¿®æ”¹å°šæœªå„²å­˜`;
}

async function saveBatchData() {
  // é©—è­‰ï¼šæ˜¯å¦æ‰€æœ‰å·²æ‹ç…§çš„éƒ½æœ‰è¼¸å…¥é‡é‡
  for (let [row, data] of pendingUpdates) {
    if (!data.weight || parseFloat(data.weight) <= 0) {
      alert(`âš ï¸ Row ${row} å·²æ‹ç…§ä½†æœªè¼¸å…¥æœ‰æ•ˆé‡é‡ï¼Œè«‹æª¢æŸ¥ï¼`);
      return;
    }
  }

  const btn = document.querySelector('#batchBar button');
  btn.disabled = true; btn.textContent = 'ğŸš€ å„²å­˜ä¸­...';

  const tasks = Array.from(pendingUpdates.entries()).map(([row, data]) => {
    const body = new URLSearchParams();
    body.append('action', 'saveArrivalData'); // éœ€è¦åœ¨ GAS å¢åŠ æ­¤ action
    body.append('password', password);
    body.append('row', row);
    body.append('image', data.image);
    body.append('weight', data.weight);
    return fetch(API, {method:'POST', body}).then(r=>r.json());
  });

  try {
    await Promise.all(tasks);
    alert('âœ… å…¨éƒ¨è³‡æ–™å·²æˆåŠŸåŒ¯å…¥ Google Sheetï¼');
    pendingUpdates.clear();
    updateUIStates();
    // æ›´æ–°æœ¬åœ°æ•¸æ“šä¸¦é‡æ–°æ¸²æŸ“
    location.reload(); 
  } catch (err) {
    alert('âŒ å„²å­˜å¤±æ•—ï¼Œè«‹é‡è©¦');
    btn.disabled = false; btn.textContent = 'ğŸ’¾ å„²å­˜å…¨éƒ¨';
  }
}

function render() {
  const listEl = document.getElementById('list');
  listEl.innerHTML = '';
  let items = allItems.filter(i => {
    if(currentFilter==='todo') return !i.image;
    if(currentFilter==='done') return !!i.image;
    return true;
  }).filter(i => {
    const arr = String(i.arrival || '').trim();
    return (currentArrival==='æœªåˆ°è²¨') ? (!arr) : (arr === currentArrival);
  });

  items.forEach(it => {
    const isPending = pendingUpdates.has(it.row);
    const currentData = pendingUpdates.get(it.row) || {};
    const displayImg = currentData.image || it.image;
    const displayWeight = currentData.weight || it.weight || '';

    const card = document.createElement('div');
    card.className = `card-fixed ${isPending ? 'pending-card' : ''}`;
    card.innerHTML = `
      <div class="card-left">
        ${it.code ? `<div class="code">${esc(it.code)}</div>` : ''}
        <div style="font-weight:bold">${esc(it.item||'')}</div>
        <div class="muted" style="font-size:12px">ID: ${esc(it.custId||'â€”')} | Pos: ${esc(it.position||'â€”')}</div>
        
        <div class="weight-input-wrap">
          <span style="font-size:14px">é‡é‡:</span>
          <input type="number" step="0.001" class="weight-input" value="${displayWeight}" placeholder="0.000">
          <span>kg</span>
        </div>
      </div>
      <div class="card-right">
        <div class="card-img-wrap">
          ${displayImg ? `<img class="card-img" src="${escAttr(displayImg)}">` : `<div class="card-img-placeholder">æœªæœ‰åœ–ç‰‡</div>`}
        </div>
        <div class="photo-actions">
          <button class="photo-btn cam">ğŸ“· æ‹ç…§</button>
          <button class="photo-btn gal">ğŸ–¼ï¸ ç›¸ç°¿</button>
        </div>
        <div class="status muted" style="font-size:11px">${isPending ? 'â³ å¾…å„²å­˜' : ''}</div>
        <input type="file" accept="image/*" style="display:none" class="file-input">
      </div>
    `;

    // é‡é‡è¼¸å…¥äº‹ä»¶
    const weightInp = card.querySelector('.weight-input');
    weightInp.oninput = () => {
      let data = pendingUpdates.get(it.row) || { image: it.image || '' };
      data.weight = weightInp.value;
      pendingUpdates.set(it.row, data);
      card.classList.add('pending-card');
      updateUIStates();
    };

    // åœ–ç‰‡ä¸Šå‚³é‚è¼¯
    const fileInp = card.querySelector('.file-input');
    card.querySelector('.cam').onclick = () => { fileInp.setAttribute('capture','environment'); fileInp.click(); };
    card.querySelector('.gal').onclick = () => { fileInp.removeAttribute('capture'); fileInp.click(); };

    fileInp.onchange = async () => {
      const f = fileInp.files[0];
      if(!f) return;
      const st = card.querySelector('.status');
      st.textContent = 'æ­£åœ¨ä¸Šå‚³...';
      try {
        const url = await compressAndUpload(f);
        let data = pendingUpdates.get(it.row) || { weight: weightInp.value };
        data.image = url;
        pendingUpdates.set(it.row, data);
        card.querySelector('.card-img-wrap').innerHTML = `<img class="card-img" src="${url}">`;
        card.classList.add('pending-card');
        st.textContent = 'âœ… å·²é è¦½ (å¾…å„²å­˜)';
        updateUIStates();
      } catch(e) { st.textContent = 'âŒ ä¸Šå‚³å¤±æ•—'; }
    };

    listEl.appendChild(card);
  });
}

// --- å·¥å…· Function ---
function buildDatalists(){
  const ids = [...new Set(allItems.map(i=>String(i.custId||'').trim()).filter(Boolean))].sort();
  document.getElementById('id-list').innerHTML = ids.map(v=>`<option value="${escAttr(v)}">`).join('');
}

function buildArrivalTabs(){
  const tabs = document.getElementById('arrivalTabs');
  tabs.innerHTML = '';
  let arrivals = [...new Set(allItems.map(i=>i.arrival).filter(a=>a && String(a).trim()))];
  arrivals.sort((a,b)=>groupNum(b)-groupNum(a));
  ['æœªåˆ°è²¨', ...arrivals.slice(0,3)].forEach(name => {
    const t = document.createElement('div');
    t.className = 'tab'; t.textContent = name;
    t.onclick = () => { currentArrival = name; render(); };
    tabs.appendChild(t);
  });
}

function groupNum(str){ const m = String(str||'').match(/\d+/); return m ? parseInt(m[0],10) : -1; }

async function compressAndUpload(file) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const max = 1200;
      let w = img.width, h = img.height;
      if (w > h && w > max) { h *= max / w; w = max; }
      else if (h > max) { w *= max / h; h = max; }
      canvas.width = w; canvas.height = h;
      canvas.getContext('2d').drawImage(img, 0, 0, w, h);
      canvas.toBlob(blob => {
        const fd = new FormData();
        fd.append('file', blob);
        fd.append('upload_preset', UPLOAD_PRESET);
        fd.append('folder', CLOUD_FOLDER);
        fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: fd })
          .then(r => r.json()).then(res => resolve(res.secure_url)).catch(reject);
      }, 'image/jpeg', 0.8);
    };
    reader.readAsDataURL(file);
  });
}

function esc(s){ return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escAttr(s){ return esc(s).replace(/\n/g,' '); }
</script>
</body>
</html>
