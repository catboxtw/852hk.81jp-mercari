<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>管理員後台</title>
<link rel="stylesheet" href="style.css?v=20251225-3">
</head>

<body>
<main class="admin-wrap">

  <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
    <h1 style="margin:0;">管理員後台</h1>
    <button id="gotoSearch" class="photo-btn" style="width:auto;">ID 查詢</button>
  </div>

  <div id="login" class="admin-login">
    <input id="pw" type="password" placeholder="管理員密碼" autocomplete="current-password">
    <button id="loginBtn" type="button">登入</button>
    <div id="loginStatus" class="muted"></div>
  </div>

  <div id="panel" style="display:none">
    <div class="filter">
      <button type="button" data-filter="todo">未完成</button>
      <button type="button" data-filter="done">已完成</button>
      <button type="button" data-filter="all">全部</button>
    </div>

    <div id="arrivalTabs" class="tabs"></div>
    <div id="list"></div>
  </div>

</main>

<datalist id="id-list"></datalist>
<datalist id="pos-list"></datalist>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const API = 'https://script.google.com/macros/s/AKfycby2I6Q2M67npEFW-Vqi14JS3L7rtuQ9DLD35KwhwCaGpyt3xBnRfNyeLcOGXfslA9sx/exec';

  const CLOUD_NAME = 'disr3dmsj';
  const UPLOAD_PRESET = 'mercariup';
  const CLOUD_FOLDER = 'mercari';

  let password = '';
  let allItems = [];
  let currentFilter = 'todo';
  let currentArrival = '未到貨';

  const loginBtn = document.getElementById('loginBtn');
  const loginStatusEl = document.getElementById('loginStatus');
  const arrivalTabsEl = document.getElementById('arrivalTabs');
  const listEl = document.getElementById('list');

  const idListEl = document.getElementById('id-list');
  const posListEl = document.getElementById('pos-list');

  document.getElementById('gotoSearch').onclick = ()=> location.href = 'id-search.html';

  loginBtn.addEventListener('click', doLogin);
  document.getElementById('pw').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doLogin(); });

  document.querySelectorAll('.filter button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      currentFilter = btn.dataset.filter;
      render();
    });
  });

  function groupNum(str){
    const m = String(str||'').match(/\d+/);
    return m ? parseInt(m[0],10) : -1;
  }

  function doLogin(){
    password = (document.getElementById('pw').value || '').trim();
    if(!password){ loginStatusEl.textContent='請輸入密碼'; return; }

    loginStatusEl.textContent='登入中…';
    loginBtn.disabled = true;

    const body = new URLSearchParams();
    body.append('action','getAdminItems');
    body.append('password',password);

    fetch(API,{method:'POST',body})
      .then(r=>r.json())
      .then(d=>{
        if(d.error) throw new Error(d.error);

        // ✅ 記住密碼俾 ID 查詢頁用
        localStorage.setItem('adminPw', password);

        allItems = Array.isArray(d.items) ? d.items : [];
        allItems = allItems.filter(it => String(it.item||'').trim()); // 去空白卡

        buildDatalists();
        buildArrivalTabs();

        document.getElementById('login').style.display='none';
        document.getElementById('panel').style.display='block';
        loginStatusEl.textContent='';
        render();
      })
      .catch(err=>{
        console.error(err);
        loginStatusEl.textContent='登入失敗';
      })
      .finally(()=> loginBtn.disabled=false);
  }

  function buildDatalists(){
    const ids = [...new Set(allItems.map(i=>String(i.custId||'').trim()).filter(Boolean))].sort();
    const poss = [...new Set(allItems.map(i=>String(i.position||'').trim()).filter(Boolean))].sort();
    idListEl.innerHTML = ids.map(v=>`<option value="${escAttr(v)}"></option>`).join('');
    posListEl.innerHTML = poss.map(v=>`<option value="${escAttr(v)}"></option>`).join('');
  }

  function buildArrivalTabs(){
    arrivalTabsEl.innerHTML='';

    let arrivals=[...new Set(allItems.map(i=>i.arrival).filter(a=>a && String(a).trim()))];
    arrivals.sort((a,b)=>groupNum(b)-groupNum(a));

    const show=['未到貨', ...arrivals.slice(0,3)];
    const more=arrivals.slice(3);

    show.forEach(name=>{
      const t=document.createElement('div');
      t.className='tab';
      t.textContent=name;
      t.onclick=()=>{ currentArrival=name; render(); };
      arrivalTabsEl.appendChild(t);
    });

    if(more.length){
      const moreTab=document.createElement('div');
      moreTab.className='tab more';
      moreTab.textContent='...';

      const list=document.createElement('div');
      list.className='more-list';

      more.forEach(name=>{
        const d=document.createElement('div');
        d.textContent=name;
        d.onclick=()=>{ currentArrival=name; render(); list.style.display='none'; };
        list.appendChild(d);
      });

      moreTab.appendChild(list);

      // ✅ desktop hover + ✅ mobile click
      moreTab.addEventListener('click', ()=>{
        list.style.display = (list.style.display==='block') ? 'none' : 'block';
      });
      moreTab.addEventListener('mouseenter', ()=>list.style.display='block');
      moreTab.addEventListener('mouseleave', ()=>list.style.display='none');

      arrivalTabsEl.appendChild(moreTab);
    }
  }

  function render(){
    listEl.innerHTML='';

    let items=[...allItems];

    if(currentFilter==='todo') items = items.filter(i=>!i.image);
    if(currentFilter==='done') items = items.filter(i=>!!i.image);

    if(currentArrival==='未到貨'){
      items = items.filter(i=>!i.arrival || !String(i.arrival).trim());
    }else{
      items = items.filter(i=>String(i.arrival).trim()===String(currentArrival).trim());
    }

    items.forEach(it=>{
      const w=parseFloat(it.weight)||0;
      const needMeta = !(String(it.position||'').trim() && String(it.custId||'').trim());

      const card=document.createElement('div');
      card.className='card-fixed';
      card.innerHTML=`
        <div class="card-left">
          ${it.code ? `<div class="code">${esc(it.code)}</div>` : ''}
          <div>${esc(it.item||'')}</div>
          ${it.link ? `<div class="item-link"><a href="${escAttr(it.link)}" target="_blank" rel="noopener">${esc(it.link)}</a></div>` : `<div class="item-link muted">（未有 Link）</div>`}
          <div class="muted">到貨日期：${esc(it.arrivalDate||'—')}</div>

          ${
            needMeta ? `
              <div class="meta-edit">
                <input class="pos" list="pos-list" placeholder="Position" value="${escAttr(it.position||'')}">
                <input class="cid" list="id-list" placeholder="ID" value="${escAttr(it.custId||'')}">
                <button class="save-btn" type="button">儲存</button>
                <div class="status muted"></div>
              </div>
            ` : `
              <div>${esc(it.position||'')}</div>
              <div>${esc(it.custId||'')}</div>
            `
          }
        </div>

        <div class="card-right">
          <div class="card-img-wrap">
            ${it.image ? `<img class="card-img" src="${escAttr(it.image)}" alt="">` : `<div class="card-img-placeholder">No Image</div>`}
          </div>
          <div class="card-weight">${w>0 ? `${w.toFixed(3)} kg` : ''}</div>

          <div class="photo-actions">
            <button class="photo-btn cam" type="button">立即拍照</button>
            <button class="photo-btn gal" type="button">新增相簿照片</button>
          </div>
          <div class="upload-status"></div>
          <input class="file" type="file" accept="image/*" style="display:none">
        </div>
      `;

      const file = card.querySelector('.file');
      const status = card.querySelector('.upload-status');
      const imgWrap = card.querySelector('.card-img-wrap');

      card.querySelector('.cam').onclick = ()=>{
        file.value='';
        file.setAttribute('capture','environment');
        file.click();
      };
      card.querySelector('.gal').onclick = ()=>{
        file.value='';
        file.removeAttribute('capture');
        file.click();
      };

      file.onchange = ()=>{
        const f = file.files && file.files[0];
        if(!f) return;

        status.textContent='上傳中…';

        compressAndUpload(f)
          .then(url => saveImageToSheet(it.row, url).then(()=>url))
          .then(url=>{
            it.image = url;
            imgWrap.innerHTML = `<img class="card-img" src="${escAttr(url)}" alt="">`;
            status.textContent='上傳成功';
          })
          .catch(err=>{
            console.error(err);
            status.textContent='上傳失敗';
          });
      };

      if(needMeta){
        const saveBtn = card.querySelector('.save-btn');
        const posEl = card.querySelector('.pos');
        const cidEl = card.querySelector('.cid');
        const stEl = card.querySelector('.status');

        saveBtn.onclick = ()=>{
          const position=(posEl.value||'').trim();
          const custId=(cidEl.value||'').trim();
          if(!position || !custId){ stEl.textContent='請同時輸入 Position 及 ID'; return; }

          stEl.textContent='儲存中…';
          saveBtn.disabled=true;

          savePositionId(it.row, position, custId)
            .then(()=>{
              it.position = position;
              it.custId = custId;
              buildDatalists();
              stEl.textContent='儲存成功';
              setTimeout(()=>render(), 80);
            })
            .catch(err=>{
              console.error(err);
              stEl.textContent='儲存失敗';
              saveBtn.disabled=false;
            });
        };
      }

      listEl.appendChild(card);
    });
  }

  function saveImageToSheet(row, imageUrl){
    const body = new URLSearchParams();
    body.append('action','saveImage');
    body.append('password',password);
    body.append('row',String(row));
    body.append('image',imageUrl);

    return fetch(API,{method:'POST',body})
      .then(r=>r.json())
      .then(d=>{ if(d.error) throw new Error(d.error); return true; });
  }

  function savePositionId(row, position, custId){
    const body = new URLSearchParams();
    body.append('action','savePositionId');
    body.append('password',password);
    body.append('row',String(row));
    body.append('position',position);
    body.append('custId',custId);

    return fetch(API,{method:'POST',body})
      .then(r=>r.json())
      .then(d=>{ if(d.error) throw new Error(d.error); return true; });
  }

  function compressAndUpload(file){
    return new Promise((resolve,reject)=>{
      const img=new Image();
      const reader=new FileReader();
      reader.onload=e=>img.src=e.target.result;
      reader.onerror=reject;

      img.onload=()=>{
        const canvas=document.createElement('canvas');
        const max=1200;
        let w=img.width,h=img.height;
        if(w>h && w>max){ h=h*(max/w); w=max; }
        else if(h>max){ w=w*(max/h); h=max; }

        canvas.width=Math.round(w);
        canvas.height=Math.round(h);
        canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height);

        canvas.toBlob(blob=>{
          const fd=new FormData();
          fd.append('file',blob);
          fd.append('upload_preset',UPLOAD_PRESET);
          fd.append('folder',CLOUD_FOLDER);

          fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`,{method:'POST',body:fd})
            .then(r=>r.json())
            .then(res=>{
              if(!res.secure_url) throw new Error(res?.error?.message||'Cloudinary upload failed');
              resolve(res.secure_url);
            })
            .catch(reject);
        },'image/jpeg',0.75);
      };

      reader.readAsDataURL(file);
    });
  }

  function esc(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function escAttr(s){ return esc(s).replace(/\n/g,' '); }
});
</script>
</body>
</html>
